<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employee Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; --hover:#f1f5f9; --blue:#0d6efd; --danger:#ef4444; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial }
    header{ position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; background:#fff; border-bottom:1px solid var(--border) }
    header h1{ margin:0; font-size:18px; font-weight:800 }
    .btn{ appearance:none; border:1px solid var(--border); background:#fff; color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer }
    .btn:hover{ background:var(--hover) }
    .btn.primary{ background:var(--blue); color:#fff; border-color:transparent }
    .btn.danger{ background:var(--danger); color:#fff; border-color:transparent }
    .wrap{ padding:16px }
    .card{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    input, select{ padding:8px 10px; border:1px solid var(--border); border-radius:10px; font:inherit }
    .muted{ color:var(--muted) }

    /* table + sticky header inside its own scroller */
    .tableWrap{ overflow:auto; border:1px solid var(--border); border-radius:12px; max-height:60vh; }
    table{ width:100%; border-collapse:separate; border-spacing:0 }
    thead th{
      position:sticky; top:0;
      z-index:2;
      background:#fff;
      border-bottom:1px solid var(--border);
      padding:10px; text-align:left; font-weight:700; white-space:nowrap;
    }
    tbody td{ border-top:1px solid var(--border); padding:10px; vertical-align:top }
    th.sort{ cursor:pointer; user-select:none }
    th.sort:after{ content:" ⇵"; color:#94a3b8; font-weight:400 }
    th.sort.asc:after{ content:" ↑" }
    th.sort.desc:after{ content:" ↓" }

    .thumb{ width:48px; height:48px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb; background:#f8fafc }
    .pager{ display:flex; gap:8px; align-items:center; margin-top:10px }

    /* modal */
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center; padding:16px }
    .modal .box{ background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; width:min(920px,96vw) }
    .box h3{ margin:8px 0 12px }

    .grid{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
    .grid label{ font-weight:600; display:block; font-size:14px }
    .grid .field{ display:flex; flex-direction:column; gap:6px }
    .imgDrop{ width:140px; height:140px; border:2px dashed #cbd5e1; border-radius:12px; display:flex; align-items:center; justify-content:center; background:#f8fafc; cursor:pointer }
    .imgDrop img{ max-width:100%; max-height:100%; border-radius:10px }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr 1fr } }
    @media (max-width:640px){ .grid{ grid-template-columns:1fr } }

    /* Action buttons inside table */
    .btn.small{ padding:6px 8px; border-radius:8px; font-size:13px }
    .actionsCell{ display:flex; gap:6px; flex-wrap:wrap }
    .hidden{ display:none }
  </style>
</head>
<body>
<header>
  <h1>Employee Directory</h1>
  <div class="row">
    <button class="btn" onclick="location.href='/'">Back</button>
  </div>
</header>

<div class="wrap">
  <div class="card" style="margin-bottom:10px">
    <div class="row" style="width:100%">
      <input id="q" placeholder="Quick search…" style="min-width:260px; flex:1 1 260px">
      <span class="muted">Timezone: IST • Dates: DD-MM-YYYY</span>
      <span id="meta" class="muted" style="margin-left:auto"></span>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="addBtn" class="btn primary">+ Add Record</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <div class="tableWrap">
      <table id="grid">
        <thead id="thead">
          <tr>
            <th class="sort" data-k="serial">Serial</th>
            <th class="sort" data-k="name">Name</th>
            <th class="sort" data-k="department">Department</th>
            <th class="sort" data-k="designation">Designation</th>
            <th class="sort" data-k="shift">Shift</th>
            <th class="sort" data-k="mobile">Mobile #</th>
            <th class="sort" data-k="email">Email</th>
            <th class="sort" data-k="gender">Gender</th>
            <th class="sort" data-k="joined">Joined On</th>
            <th class="sort" data-k="salary">Salary</th>
            <th>Photo</th>
            <th id="colActions">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="pager">
      <button id="prevBtn" class="btn">Prev</button>
      <span id="pageInfo" class="muted">Page 1 / 1</span>
      <button id="nextBtn" class="btn">Next</button>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="empModal" class="modal" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true">
    <h3 id="modalTitle">Add Record</h3>
    <input type="hidden" id="m_serial" />
    <div class="grid">
      <div class="field">
        <label for="m_name">Name *</label>
        <input id="m_name" required />
      </div>
      <div class="field">
        <label for="m_mobile">Mobile Number</label>
        <input id="m_mobile" inputmode="numeric" placeholder="10 digits" />
      </div>
      <div class="field">
        <label for="m_department">Department</label>
        <input id="m_department" placeholder="e.g., Finance" />
      </div>

      <div class="field">
        <label for="m_designation">Designation</label>
        <input id="m_designation" placeholder="e.g., Manager" />
      </div>
      <div class="field">
        <label for="m_shift">Shift</label>
        <select id="m_shift">
          <option>Day</option>
          <option>Night</option>
        </select>
      </div>
      <div class="field">
        <label for="m_email">Email</label>
        <input id="m_email" type="email" placeholder="name@domain.com" />
      </div>

      <div class="field">
        <label>Gender</label>
        <div class="row">
          <label><input type="radio" name="m_gender" value="Male" checked /> Male</label>
          <label><input type="radio" name="m_gender" value="Female" /> Female</label>
        </div>
      </div>
      <div class="field">
        <label for="m_joined">Joined On</label>
        <input id="m_joined" type="date" />
        <span class="muted">Saved as <b>DD-MM-YYYY</b> (Asia/Kolkata)</span>
      </div>
      <div class="field">
        <label for="m_salary">Salary</label>
        <input id="m_salary" type="number" step="0.01" min="0" value="0" />
      </div>

      <div class="field">
        <label>Photo</label>
        <div class="imgDrop" onclick="document.getElementById('m_file').click()">
          <span id="imgHint">+</span>
          <img id="imgPreview" alt="" style="display:none" />
        </div>
        <input id="m_file" type="file" accept="image/*" style="display:none" />
        <input id="m_photoUrl" type="url" placeholder="Photo URL (auto-filled after upload)" />
        <span id="m_status" class="muted"></span>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button id="m_save" class="btn primary">Save</button>
    </div>
  </div>
</div>

<script>
/* ===== Config ===== */
const API = '/api';
const IST = 'Asia/Kolkata';
const PAGE = 12;

/* ===== Helpers ===== */
const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const token = () => { try{ return localStorage.getItem('token'); }catch{ return null; } };

function fmtDateIST(d){
  if(!d) return '';
  const dt = new Date(d);
  if(isNaN(dt)) return esc(d);
  const p = new Intl.DateTimeFormat('en-GB',{ timeZone: IST, day:'2-digit', month:'2-digit', year:'numeric' }).formatToParts(dt);
  const g = k => p.find(x=>x.type===k)?.value || '';
  return `${g('day')}-${g('month')}-${g('year')}`;
}
function toDateInputValueIST(d){
  const dt = d ? new Date(d) : new Date();
  return new Intl.DateTimeFormat('en-CA',{ timeZone: IST, year:'numeric', month:'2-digit', day:'2-digit' }).format(dt);
}

/* ===== State ===== */
let isAdmin = false;
let all = [];           // rows from API
let rows = [];          // filtered/sorted view
let sortKey = 'serial';
let sortDir = 'asc';
let page = 1;

/* ===== API ===== */
async function fetchEmployees(){
  const r = await fetch(`${API}?action=directory&token=${encodeURIComponent(token()||'')}`, {cache:'no-store'});
  const j = await r.json();
  if(!j.ok) throw new Error(j.error || 'Failed to load directory');
  return j.data || [];
}
async function addEmployee(p){
  const r = await fetch(`${API}?action=addemp&token=${encodeURIComponent(token()||'')}`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(p)
  });
  const j = await r.json(); if(!j.ok) throw new Error(j.error||'Add failed'); return j.data;
}
async function updateEmployee(p){
  const r = await fetch(`${API}?action=updateemp&token=${encodeURIComponent(token()||'')}`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(p)
  });
  const j = await r.json(); if(!j.ok) throw new Error(j.error||'Update failed'); return j.data;
}
async function deleteEmployee(serial){
  const r = await fetch(`${API}?action=deleteemp&token=${encodeURIComponent(token()||'')}`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({serial})
  });
  const j = await r.json(); if(!j.ok) throw new Error(j.error||'Delete failed'); return j.data;
}

/* ===== UI ===== */
function apply(){
  const q = (document.getElementById('q').value || '').toLowerCase();
  rows = all.filter(r => {
    const hay = [
      r.serial, r.name, r.department, r.designation, r.shift, r.mobile, r.email, r.gender, fmtDateIST(r.joined), r.salary
    ].map(v => String(v || '').toLowerCase()).join(' ');
    return !q || hay.includes(q);
  }).sort((a,b) => {
    let A,B;
    if(sortKey === 'salary'){ A = Number(a.salary)||0; B = Number(b.salary)||0; }
    else if(sortKey === 'joined'){ A = new Date(a.joined||0); B = new Date(b.joined||0); }
    else if(sortKey === 'serial'){ A = Number(a.serial)||0; B = Number(b.serial)||0; }
    else { A = (a[sortKey] ?? '').toString().toLowerCase(); B = (b[sortKey] ?? '').toString().toLowerCase(); }
    const s = (A<B?-1:A>B?1:0);
    return sortDir==='asc'? s : -s;
  });
  render();
}
function render(){
  const tbody = document.querySelector('#grid tbody'); tbody.innerHTML = '';
  const total = rows.length, pages = Math.max(1, Math.ceil(total / PAGE));
  page = Math.min(Math.max(1, page), pages);
  const part = rows.slice((page-1)*PAGE, (page-1)*PAGE + PAGE);
  part.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(r.serial)}</td>
      <td>${esc(r.name)}</td>
      <td>${esc(r.department||'')}</td>
      <td>${esc(r.designation||'')}</td>
      <td>${esc(r.shift||'')}</td>
      <td>${esc(r.mobile||'')}</td>
      <td>${esc(r.email||'')}</td>
      <td>${esc(r.gender||'')}</td>
      <td>${fmtDateIST(r.joined)}</td>
      <td>${Number(r.salary||0).toLocaleString(undefined,{maximumFractionDigits:2})}</td>
      <td>${r.photo ? `<a href="${esc(r.photo)}" target="_blank"><img class="thumb" src="${esc(r.photo)}" alt=""></a>` : ''}</td>
      <td class="actionsCell">${isAdmin
        ? `<button class="btn small" onclick="openModal(true, ${r.serial})">Edit</button>
           <button class="btn small danger" onclick="delEmp(${r.serial})">Delete</button>`
        : ''}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('pageInfo').textContent = `Page ${page} / ${pages}`;
  document.getElementById('status').textContent = `${total} employee(s), showing ${part.length}`;
}

/* ===== Modal ===== */
function openModal(edit=false, serial=null){
  const box = document.getElementById('empModal');
  document.getElementById('modalTitle').textContent = edit ? 'Edit Record' : 'Add Record';
  document.getElementById('m_status').textContent = '';
  if(edit){
    const r = all.find(x => String(x.serial) === String(serial));
    if(!r) return;
    document.getElementById('m_serial').value = r.serial;
    document.getElementById('m_name').value = r.name || '';
    document.getElementById('m_department').value = r.department || '';
    document.getElementById('m_designation').value = r.designation || '';
    document.getElementById('m_shift').value = r.shift || 'Day';
    document.getElementById('m_mobile').value = r.mobile || '';
    document.getElementById('m_email').value = r.email || '';
    document.querySelector(`input[name="m_gender"][value="${r.gender||'Male'}"]`).checked = true;
    document.getElementById('m_joined').value = toDateInputValueIST(r.joined);
    document.getElementById('m_salary').value = r.salary || 0;
    document.getElementById('m_photoUrl').value = r.photo || '';
    const img = document.getElementById('imgPreview'); const hint = document.getElementById('imgHint');
    if(r.photo){ img.src = r.photo; img.style.display='block'; hint.style.display='none'; } else { img.style.display='none'; hint.style.display='block'; }
  }else{
    document.getElementById('m_serial').value = '';
    document.getElementById('m_name').value = '';
    document.getElementById('m_department').value = '';
    document.getElementById('m_designation').value = '';
    document.getElementById('m_shift').value = 'Day';
    document.getElementById('m_mobile').value = '';
    document.getElementById('m_email').value = '';
    document.querySelector('input[name="m_gender"][value="Male"]').checked = true;
    document.getElementById('m_joined').value = toDateInputValueIST();
    document.getElementById('m_salary').value = 0;
    document.getElementById('m_photoUrl').value = '';
    const img = document.getElementById('imgPreview'); const hint = document.getElementById('imgHint');
    img.style.display='none'; hint.style.display='block';
  }
  box.style.display='flex';
}
function closeModal(){ document.getElementById('empModal').style.display='none'; }

/* ===== Upload to Apps Script drive endpoint ===== */
async function uploadFile(file, statusEl, targetInput){
  if(!file) return;
  statusEl.textContent = 'Uploading…';
  try{
    const buf = await file.arrayBuffer();
    const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
    const r = await fetch(`${API}?action=uploaddocb64&token=${encodeURIComponent(token()||'')}`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name:file.name, mime:file.type||'application/octet-stream', data:b64 })
    });
    const j = await r.json().catch(()=>({ok:false,error:'Bad JSON'}));
    if(!j.ok) throw new Error(j.error || 'Upload failed');
    targetInput.value = j.data.url;
    statusEl.textContent = 'Uploaded.';
  }catch(e){
    statusEl.textContent = 'Upload failed: '+ e.message;
  }
}

/* ===== Save/Delete via API ===== */
async function saveFromModal(){
  const sEl = document.getElementById('m_status');
  const name = document.getElementById('m_name').value.trim();
  if(!name){ sEl.textContent = 'Name is required.'; return; }

  const payload = {
    serial: document.getElementById('m_serial').value || undefined, // undefined => add
    name,
    department: document.getElementById('m_department').value.trim(),
    designation: document.getElementById('m_designation').value.trim(),
    shift: document.getElementById('m_shift').value,
    mobile: document.getElementById('m_mobile').value.trim(),
    email: document.getElementById('m_email').value.trim(),
    gender: document.querySelector('input[name="m_gender"]:checked').value,
    joined: document.getElementById('m_joined').value,  // yyyy-mm-dd
    salary: document.getElementById('m_salary').value,
    photo: document.getElementById('m_photoUrl').value.trim()
  };

  try{
    sEl.textContent = 'Saving…';
    if(payload.serial){ await updateEmployee(payload); }
    else { await addEmployee(payload); }
    closeModal();
    all = await fetchEmployees();   // refresh
    apply();
  }catch(e){ sEl.textContent = 'Save failed: '+ e.message; }
}
async function delEmp(serial){
  if(!isAdmin) return;
  if(!confirm('Delete employee #'+serial+'?')) return;
  try{
    await deleteEmployee(serial);
    all = await fetchEmployees();
    apply();
  }catch(e){ alert('Delete failed: ' + e.message); }
}

/* ===== Sort + Events ===== */
function attachSort(){
  document.querySelectorAll('#thead th.sort').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.k;
      if(sortKey === k) sortDir = (sortDir === 'asc' ? 'desc' : 'asc');
      else { sortKey = k; sortDir = 'asc'; }
      document.querySelectorAll('#thead th.sort').forEach(x=>x.classList.remove('asc','desc'));
      th.classList.add(sortDir);
      apply();
    });
  });
}
function attachEvents(){
  document.getElementById('q').addEventListener('input', apply);
  document.getElementById('prevBtn').onclick = () => { page = Math.max(1, page-1); render(); };
  document.getElementById('nextBtn').onclick = () => { page = page+1; render(); };
  document.getElementById('addBtn').onclick = () => openModal(false);

  document.getElementById('m_file').addEventListener('change', ev=>{
    const f = ev.target.files[0]; if(!f) return;
    const img = document.getElementById('imgPreview'); const hint = document.getElementById('imgHint');
    const reader = new FileReader();
    reader.onload = e => { img.src = e.target.result; img.style.display='block'; hint.style.display='none'; };
    reader.readAsDataURL(f);
    uploadFile(f, document.getElementById('m_status'), document.getElementById('m_photoUrl'));
  });

  document.getElementById('m_save').onclick = saveFromModal;
}

/* ===== Admin detection ===== */
async function detectAdmin(){
  try{
    const r = await fetch(`${API}?action=whoami&token=${encodeURIComponent(token()||'')}`,{ cache:'no-store' });
    const j = await r.json();
    if(j && j.ok && j.data && j.data.user && String(j.data.user.role||'').toLowerCase()==='admin'){
      isAdmin = true;
    }
  }catch(_){ /* ignore */ }
  if(!isAdmin){ document.getElementById('colActions').classList.add('hidden'); }
}

/* ===== Init ===== */
(async function init(){
  document.getElementById('meta').textContent = '';
  attachEvents(); attachSort(); await detectAdmin();

  try {
    all = await fetchEmployees();   // load rows from the “Directory” sheet
  } catch (e) {
    document.getElementById('status').textContent = 'Load failed: ' + e.message;
    all = [];
  }
  apply();
})();
</script>
</body>
</html>
