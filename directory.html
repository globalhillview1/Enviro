<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employee Directory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:#f7f9fc;color:#0f172a}
    header{padding:12px 16px;background:#fff;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between}
    header h1{margin:0;font-size:18px;font-weight:800}
    .btn{padding:8px 14px;border-radius:8px;border:1px solid #e5e7eb;cursor:pointer;font-size:14px;background:#fff}
    .btn:hover{background:#f1f5f9}
    .btn.primary{background:#0d6efd;color:#fff;border-color:transparent}
    .btn.danger{background:#ef4444;color:#fff;border-color:transparent}
    .wrap{padding:16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:20px;max-width:520px;margin:auto}
    h2{margin-top:0}
    form label{display:block;margin-top:12px;font-weight:600}
    form input,form select{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;margin-top:4px;font-size:14px}
    .row{display:flex;gap:16px;align-items:center;margin-top:12px}
    .row input[type="radio"]{width:auto;margin-right:6px}
    .muted{font-size:12px;color:#6b7280}
    .error{color:#ef4444;font-size:12px;margin-top:2px;display:none}
    .actions{margin-top:16px;display:flex;gap:10px}
    .imgBox{width:120px;height:120px;border:2px dashed #cbd5e1;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:#f8fafc}
    .imgBox img{max-width:100%;max-height:100%;border-radius:8px}
    .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid currentColor; border-right-color:transparent; display:inline-block; animation:spin .7s linear infinite }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<header>
  <h1>Employee Directory</h1>
  <button class="btn" onclick="location.href='/'">Back</button>
</header>

<div class="wrap">
  <div class="card">
    <h2>Add Record</h2>
    <form id="empForm" novalidate>
      <label>Name *
        <input id="name" required />
        <div class="error" id="errName">Name is required</div>
      </label>

      <label>Email
        <input id="email" type="email" placeholder="Enter email…" />
      </label>

      <label>Gender *</label>
      <div class="row">
        <label><input type="radio" name="gender" value="Male" checked /> Male</label>
        <label><input type="radio" name="gender" value="Female" /> Female</label>
      </div>

      <label>Joined On
        <input id="joined" type="date" />
        <div class="muted">Saved as DD-MM-YYYY (Asia/Kolkata)</div>
      </label>

      <label>Salary
        <input id="salary" type="number" step="0.01" min="0" value="0.00" />
      </label>

      <label>Image (optional)</label>
      <div class="imgBox" onclick="document.getElementById('image').click()">
        <span id="imgHint">+</span>
        <img id="imgPreview" style="display:none" alt="preview" />
      </div>
      <input id="image" type="file" accept="image/*" style="display:none" />

      <div class="actions">
        <button type="submit" id="submitBtn" class="btn primary">Submit Form</button>
        <button type="reset" class="btn">Reset</button>
        <button type="button" class="btn danger" onclick="cancelForm()">Cancel</button>
      </div>
      <div class="muted" id="statusMsg"></div>
    </form>
  </div>
</div>

<script>
/* ---------- CONFIG: HARD-CODE YOUR GAS URL HERE ---------- */
const API = 'https://script.google.com/macros/s/AKfycbXXXXXXXXXXXXXXXXXXXXXXXXXXXX/exec'; // <-- replace with your Web App URL
/* --------------------------------------------------------- */

const TZ = 'Asia/Kolkata';

function cancelForm(){ location.href='/'; }
function token(){ try{ return localStorage.getItem('token'); }catch{ return null; } }
function setBusy(btn,on,txtIdle,txtBusy){
  if(!btn) return;
  if(on){ btn.disabled=true; btn.dataset._w=btn.offsetWidth; btn.style.minWidth=btn.dataset._w+'px'; btn.innerHTML=`<span class="spinner"></span> ${txtBusy}`; }
  else  { btn.disabled=false; btn.style.minWidth=''; btn.innerHTML=txtIdle; }
}
function toDDMMYYYYFromDateInput(ymd){
  if(!ymd) return '';
  const [y,m,d] = ymd.split('-');
  return `${d}-${m}-${y}`;
}
function todayYMD_IST(){
  const now = new Date();
  const opts = { timeZone: TZ, year:'numeric', month:'2-digit', day:'2-digit' };
  const [mm,dd,yyyy] = now.toLocaleDateString('en-IN', opts).split('/');
  return `${yyyy}-${mm}-${dd}`;
}
function fileToBase64_(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}

/* Preview image */
document.getElementById('image').addEventListener('change',ev=>{
  const file=ev.target.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=e=>{
      document.getElementById('imgPreview').src=e.target.result;
      document.getElementById('imgPreview').style.display='block';
      document.getElementById('imgHint').style.display='none';
    };
    reader.readAsDataURL(file);
  }else{
    document.getElementById('imgPreview').style.display='none';
    document.getElementById('imgHint').style.display='block';
  }
});

/* Submit */
const form=document.getElementById('empForm');
form.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const btn = document.getElementById('submitBtn');
  const status = document.getElementById('statusMsg');

  const name=document.getElementById('name').value.trim();
  if(!name){ document.getElementById('errName').style.display='block'; return; }
  document.getElementById('errName').style.display='none';

  const payload={
    name,
    email:document.getElementById('email').value.trim(),
    gender:form.gender.value,
    joined:toDDMMYYYYFromDateInput(document.getElementById('joined').value), // DD-MM-YYYY
    salary:document.getElementById('salary').value || '0'
  };

  let imageUrl = '';
  const f = document.getElementById('image').files[0];

  try{
    setBusy(btn,true,'Submit Form','Submitting…'); status.textContent='';

    // Optional image upload to Drive
    if(f){
      const b64 = await fileToBase64_(f); // data:<mime>;base64,XXXX
      const upRes = await fetch(`${API}?action=uploaddocb64${token()?`&token=${encodeURIComponent(token())}`:''}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name: f.name, mime: f.type, data: b64.split(',')[1] })
      });
      const upJ = await upRes.json();
      if(!upJ.ok) throw new Error(upJ.error||'Upload failed');
      imageUrl = upJ.data.url;
    }

    // Add employee
    const res = await fetch(`${API}?action=addemployee${token()?`&token=${encodeURIComponent(token())}`:''}`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ...payload, imageUrl })
    });
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || 'Save failed');

    alert('Employee saved.');
    form.reset();
    document.getElementById('imgPreview').style.display='none';
    document.getElementById('imgHint').style.display='block';
    document.getElementById('joined').value = todayYMD_IST();
    status.textContent = 'Saved.';
  }catch(err){
    alert('Save failed: ' + err.message);
    status.textContent = 'Failed: ' + err.message;
  }finally{
    setBusy(btn,false,'Submit Form','Submitting…');
  }
});

/* Default date = today (IST) */
document.getElementById('joined').value = todayYMD_IST();
</script>
</body>
</html>
