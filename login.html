<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign in | Global Hillview Helpdesk</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f5f7fb; margin:0; }
    .wrap { max-width: 420px; margin: 48px auto; background:#fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.07); padding: 28px; }
    .logo { text-align:center; margin-bottom: 18px; }
    .title { font-size: 22px; font-weight: 700; text-align:center; margin: 6px 0 18px; }
    label { display:block; font-size: 13px; color:#333; margin: 10px 0 6px; }
    input { width:100%; padding: 10px 12px; border:1px solid #d6dae3; border-radius:8px; font-size:14px; }
    button { width:100%; margin-top:16px; padding: 12px; border:0; border-radius:8px; background:#1b74e4; color:#fff; font-weight:700; font-size:15px; cursor:pointer; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .err { display:none; margin-top:12px; padding:10px; border-radius:8px; background:#ffe5e5; color:#8a1f1f; font-size:13px; }
    .hint { margin-top:10px; color:#666; font-size:12px; text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="logo">
      <img src="/id.png" alt="Global Hillview" height="56">
    </div>
    <div class="title">Sign in</div>

    <!-- The form IDs below are the ones the script expects -->
    <form id="loginForm" novalidate>
      <label for="u">Username</label>
      <input id="u" name="username" autocomplete="username" required />

      <label for="p">Password</label>
      <input id="p" name="password" type="password" autocomplete="current-password" required />

      <button id="btn" type="submit">Sign in</button>
      <div id="err" class="err"></div>
    </form>

    <div class="hint">Tip: ask an admin to create or reset your account.</div>
  </div>

  <script>
  // Run after DOM is ready to avoid "null addEventListener"
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('loginForm');
    const btn  = document.getElementById('btn');
    const err  = document.getElementById('err');
    const uEl  = document.getElementById('u');
    const pEl  = document.getElementById('p');

    if (!form || !btn || !err || !uEl || !pEl) {
      console.error('Login page: required elements not found.');
      return;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      err.style.display = 'none';
      err.textContent = '';
      btn.disabled = true;

      const username = uEl.value.trim();
      const password = pEl.value;

      try {
        const resp = await fetch('/api?action=login', {
          method: 'POST',
          headers: {
            'content-type': 'application/json',
            'accept': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });

        // If Cloudflare worker ever proxies a non-JSON error HTML,
        // this will throw and end up in the catch block.
        const res = await resp.json();

        // Backend shape: { ok:true, data:{ token, user:{...} } }
        if (res && res.ok && res.data && res.data.token) {
          localStorage.setItem('token', res.data.token);
          if (res.data.user) localStorage.setItem('enviro_user', JSON.stringify(res.data.user));
          // Use replace() so the login page isn't in history
          location.replace('/');
          return;
        }

        throw new Error((res && (res.error || res.message)) || 'Login failed');

      } catch (e) {
        console.error('Login error', e);
        err.textContent = e && e.message ? e.message : 'Network error. Please try again.';
        err.style.display = 'block';
      } finally {
        btn.disabled = false;
      }
    });
  });
  </script>
</body>
</html>
