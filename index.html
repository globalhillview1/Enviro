<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Helpdesk – Issues</title>
  <style>
    :root{
      --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; --hover:#f1f5f9;
      --blue:#0d6efd; --danger:#ef4444; --ok:#16a34a; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:var(--bg);border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:28px;width:28px;border-radius:6px;object-fit:cover}
    .title{font-weight:800;font-size:18px;margin:0}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{background:var(--hover)}
    .btn.primary{background:var(--blue);color:#fff;border-color:transparent}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    .wrap{padding:14px 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    input,select{padding:8px 10px;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:90px;background:var(--card);border-bottom:1px solid var(--border);padding:10px;text-align:left;font-weight:700;white-space:nowrap}
    tbody td{border-top:1px solid var(--border);padding:10px;vertical-align:top}
    th.sort{cursor:pointer;user-select:none}
    th.sort:after{content:" ⇵";color:#94a3b8;font-weight:400}
    th.sort.asc:after{content:" ↑";}
    th.sort.desc:after{content:" ↓";}
    thead tr.filters th{background:#f8fafc;position:sticky;top:122px;z-index:1}
    thead tr.filters input, thead tr.filters select{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:8px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .b-open{color:#111;background:#e2e8f0}
    .b-inprog{color:#111;background:#fde68a}
    .b-res{color:#fff;background:#16a34a}
    .thumb{width:58px;height:44px;object-fit:cover;border-radius:5px;border:1px solid #e5e7eb;background:#f8fafc}
    .fileicon{display:inline-flex;align-items:center;gap:6px;padding:3px 6px;border:1px solid #e5e7eb;border-radius:6px;color:#334155;background:#f8fafc;font-size:12px}
    .fileicon svg{width:14px;height:14px}
    .row{display:flex;align-items:center;gap:8px}
    .muted{color:var(--muted)}
    .pager{display:flex;gap:8px;align-items:center;margin-top:10px}
    .pager .btn{padding:6px 10px}
    .editgrp{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .remark{min-width:220px;max-width:420px}
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="/android-chrome-512x512.png" onerror="this.src='logo.png'" alt="logo">
    <h1 class="title">Helpdesk – Issues</h1>
  </div>
  <div class="row">
    <button class="btn" onclick="location.href='/documents'">Documents</button>
    <button class="btn" onclick="location.href='/notices'">Notices</button>
    <button class="btn danger" onclick="logout()">Logout</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <!-- top bar -->
    <div class="toolbar">
      <input id="q" placeholder="Quick search…">
      <span class="muted" id="meta"></span>
      <span style="margin-left:auto" class="muted" id="status"></span>
    </div>

    <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
      <table id="grid">
        <thead id="thead">
          <tr>
            <th class="sort" data-k="Tracking ID">Tracking ID</th>
            <th class="sort" data-k="Date & Time Raised">Date & Time Raised</th>
            <th class="sort" data-k="Tower">Tower</th>
            <th class="sort" data-k="Flat">Flat</th>
            <th class="sort" data-k="Issue">Issue</th>
            <th class="sort" data-k="Description">Description</th>
            <th class="sort" data-k="Media">Media</th>
            <th class="sort" data-k="Status">Status</th>
            <th class="sort" data-k="Redressal Remark">Redressal Remark</th>
            <th class="sort" data-k="User ID">User ID</th>
            <th class="sort" data-k="Date & Time Resolved">Date & Time Resolved</th>
            <th class="sort" data-k="Time Taken">Time Taken</th>
            <th class="sort" data-k="Feedback">Feedback</th>
            <th>Actions</th>
          </tr>
          <!-- per-column filters -->
          <tr class="filters">
            <th><input id="f_tracking" placeholder="#"></th>
            <th><input id="f_raised" placeholder="dd-mm-yyyy"></th>
            <th><input id="f_tower" placeholder="tower…"></th>
            <th><input id="f_flat" placeholder="flat…"></th>
            <th><input id="f_issue" placeholder="contains…"></th>
            <th><input id="f_desc" placeholder="contains…"></th>
            <th><input id="f_media" placeholder="contains…"></th>
            <th>
              <select id="f_status">
                <option value="">Any</option>
                <option>Open</option>
                <option>InProgress</option>
                <option>Resolved</option>
              </select>
            </th>
            <th><input id="f_remark" placeholder="contains…"></th>
            <th><input id="f_user" placeholder="id…"></th>
            <th><input id="f_resolved" placeholder="dd-mm-yyyy"></th>
            <th><input id="f_taken" placeholder="e.g. 1h 20m"></th>
            <th><input id="f_feedback" placeholder="★"></th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="pager">
      <button id="prevBtn" class="btn">Prev</button>
      <span class="muted" id="pageInfo">Page 1 / 1</span>
      <button id="nextBtn" class="btn">Next</button>
    </div>
  </div>
</div>

<script>
const API = '/api';
const IST = 'Asia/Kolkata';
const PAGE_SIZE = 10;

function logout(){ try{ localStorage.clear(); }catch{} location.replace('/login'); }
function token(){ try{ return localStorage.getItem('token'); }catch{ return null; } }
const esc = s => String(s??'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function fmtDateTimeIST(d){
  if(!d) return '';
  // Handle ISO or Apps Script date serial / Date string
  const dt = new Date(d);
  if(isNaN(dt)) return esc(d);
  const p = new Intl.DateTimeFormat('en-GB',{timeZone:IST,day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}).formatToParts(dt);
  const get=k=>p.find(x=>x.type===k)?.value||'';
  return `${get('day')}-${get('month')}-${get('year')}, ${get('hour')}:${get('minute')}`;
}
function fmtDateIST(d){
  if(!d) return '';
  const dt = new Date(d);
  if(isNaN(dt)) return esc(d);
  const p = new Intl.DateTimeFormat('en-GB',{timeZone:IST,day:'2-digit',month:'2-digit',year:'numeric'}).formatToParts(dt);
  const get=k=>p.find(x=>x.type===k)?.value||'';
  return `${get('day')}-${get('month')}-${get('year')}`;
}

function gdriveId(url){
  if(!url) return null;
  const m=/\/d\/([a-zA-Z0-9_-]{10,})\//.exec(url)||/id=([a-zA-Z0-9_-]{10,})/.exec(url);
  return m?m[1]:null;
}
function driveThumb(url){
  const id=gdriveId(url);
  return id?`https://drive.google.com/thumbnail?authuser=0&sz=w200&id=${id}`:null;
}
function icon(name,label){
  const svg={
    pdf:'<svg viewBox="0 0 24 24" fill="none"><path d="M6 2h8l4 4v16H6z" stroke="currentColor"/><text x="6" y="14" font-size="8" fill="currentColor">PDF</text></svg>',
    doc:'<svg viewBox="0 0 24 24" fill="none"><path d="M6 2h8l4 4v16H6z" stroke="currentColor"/><text x="6" y="14" font-size="8" fill="currentColor">DOC</text></svg>',
    xls:'<svg viewBox="0 0 24 24" fill="none"><path d="M6 2h8l4 4v16H6z" stroke="currentColor"/><text x="6" y="14" font-size="8" fill="currentColor">XLS</text></svg>',
    ppt:'<svg viewBox="0 0 24 24" fill="none"><path d="M6 2h8l4 4v16H6z" stroke="currentColor"/><text x="6" y="14" font-size="8" fill="currentColor">PPT</text></svg>',
    csv:'<svg viewBox="0 0 24 24" fill="none"><path d="M6 2h8l4 4v16H6z" stroke="currentColor"/><text x="6" y="14" font-size="8" fill="currentColor">CSV</text></svg>',
    zip:'<svg viewBox="0 0 24 24" fill="none"><rect x="5" y="2" width="14" height="20" rx="2" stroke="currentColor"/><path d="M12 4v14" stroke="currentColor" /><path d="M10 6h4M10 8h4M10 10h4" stroke="currentColor"/></svg>'
  }[name]||'';
  return `<span class="fileicon" title="${esc(label||name)}">${svg}<span>${esc(label||name)}</span></span>`;
}
function mediaCell(url){
  if(!url) return '';
  const lower=url.toLowerCase();
  const img = (/\.(png|jpg|jpeg|gif|webp)$/i.test(lower) || driveThumb(url));
  if(img){
    const src=/\.(png|jpg|jpeg|gif|webp)$/i.test(lower)?url:driveThumb(url);
    return `<a href="${esc(url)}" target="_blank"><img class="thumb" src="${esc(src)}" loading="lazy" alt="media"></a>`;
  }
  if(/\.pdf($|\?)/i.test(lower))  return `<a href="${esc(url)}" target="_blank">${icon('pdf','PDF')}</a>`;
  if(/\.(doc|docx)($|\?)/i.test(lower)) return `<a href="${esc(url)}" target="_blank">${icon('doc','DOC')}</a>`;
  if(/\.(xls|xlsx)($|\?)/i.test(lower)) return `<a href="${esc(url)}" target="_blank">${icon('xls','XLS')}</a>`;
  if(/\.(ppt|pptx)($|\?)/i.test(lower)) return `<a href="${esc(url)}" target="_blank">${icon('ppt','PPT')}</a>`;
  if(/\.csv($|\?)/i.test(lower))  return `<a href="${esc(url)}" target="_blank">${icon('csv','CSV')}</a>`;
  if(/\.zip($|\?)/i.test(lower))  return `<a href="${esc(url)}" target="_blank">${icon('zip','ZIP')}</a>`;
  return `<a href="${esc(url)}" target="_blank">open</a>`;
}

let all = [];          // raw data from API
let rows = [];         // filtered + sorted
let sortKey = 'Date & Time Raised';
let sortDir = 'desc';
let page = 1;

function badgeStatus(s){
  const v=String(s||'').replace(/\s+/g,'').toLowerCase();
  if(v==='open') return `<span class="badge b-open">Open</span>`;
  if(v==='inprogress') return `<span class="badge b-inprog">InProgress</span>`;
  if(v==='resolved') return `<span class="badge b-res">Resolved</span>`;
  return esc(s||'');
}

// FILTERS
function readFilters(){
  return {
    quick:(document.getElementById('q').value||'').toLowerCase(),
    tracking:(document.getElementById('f_tracking').value||'').toLowerCase(),
    raised:(document.getElementById('f_raised').value||''),
    tower:(document.getElementById('f_tower').value||'').toLowerCase(),
    flat:(document.getElementById('f_flat').value||'').toLowerCase(),
    issue:(document.getElementById('f_issue').value||'').toLowerCase(),
    desc:(document.getElementById('f_desc').value||'').toLowerCase(),
    media:(document.getElementById('f_media').value||'').toLowerCase(),
    status:(document.getElementById('f_status').value||''),
    remark:(document.getElementById('f_remark').value||'').toLowerCase(),
    user:(document.getElementById('f_user').value||'').toLowerCase(),
    resolved:(document.getElementById('f_resolved').value||''),
    taken:(document.getElementById('f_taken').value||'').toLowerCase(),
    feedback:(document.getElementById('f_feedback').value||'').toLowerCase()
  };
}

function apply(){
  const f=readFilters();
  const hayOf = r => ([
    r['Tracking ID'], r['Date & Time Raised'], r['Tower'], r['Flat'],
    r['Issue'], r['Description'], r['Media'], r['Status'], r['Redressal Remark'],
    r['User ID'], r['Date & Time Resolved'], r['Time Taken'], r['Feedback']
  ].map(v=>String(v||'').toLowerCase()).join(' '));

  rows = all.filter(r=>{
    if(f.quick && hayOf(r).indexOf(f.quick)===-1) return false;
    if(f.tracking && String(r['Tracking ID']).toLowerCase().indexOf(f.tracking)===-1) return false;
    if(f.raised && String(fmtDateIST(r['Date & Time Raised'])).indexOf(f.raised)===-1) return false;
    if(f.tower && String(r['Tower']||'').toLowerCase().indexOf(f.tower)===-1) return false;
    if(f.flat && String(r['Flat']||'').toLowerCase().indexOf(f.flat)===-1) return false;
    if(f.issue && String(r['Issue']||'').toLowerCase().indexOf(f.issue)===-1) return false;
    if(f.desc && String(r['Description']||'').toLowerCase().indexOf(f.desc)===-1) return false;
    if(f.media && String(r['Media']||'').toLowerCase().indexOf(f.media)===-1) return false;
    if(f.status && String(r['Status']||'').replace(/\s+/g,'').toLowerCase()!==f.status.toLowerCase().replace(/\s+/g,'')) return false;
    if(f.remark && String(r['Redressal Remark']||'').toLowerCase().indexOf(f.remark)===-1) return false;
    if(f.user && String(r['User ID']||'').toLowerCase().indexOf(f.user)===-1) return false;
    if(f.resolved && String(fmtDateIST(r['Date & Time Resolved'])).indexOf(f.resolved)===-1) return false;
    if(f.taken && String(r['Time Taken']||'').toLowerCase().indexOf(f.taken)===-1) return false;
    if(f.feedback && String(r['Feedback']||'').toLowerCase().indexOf(f.feedback)===-1) return false;
    return true;
  });

  rows.sort((a,b)=>{
    const k=sortKey;
    if(k==='Date & Time Raised' || k==='Date & Time Resolved'){
      const A=new Date(a[k]||0), B=new Date(b[k]||0);
      return sortDir==='asc' ? (A-B):(B-A);
    }
    const A=(a[k]??'').toString().toLowerCase();
    const B=(b[k]??'').toString().toLowerCase();
    if(A<B) return sortDir==='asc'?-1:1;
    if(A>B) return sortDir==='asc'? 1:-1;
    return 0;
  });

  page = 1;
  render();
}

function render(){
  const tbody=document.querySelector('#grid tbody');
  tbody.innerHTML='';
  const total = rows.length;
  const pages = Math.max(1, Math.ceil(total/PAGE_SIZE));
  page = Math.min(Math.max(1,page), pages);
  const start=(page-1)*PAGE_SIZE;
  const part=rows.slice(start, start+PAGE_SIZE);

  part.forEach(r=>{
    const tr=document.createElement('tr');
    const tracking = r['Tracking ID'];
    const statusVal = String(r['Status']||'');
    tr.innerHTML = `
      <td>${esc(tracking)}</td>
      <td>${fmtDateTimeIST(r['Date & Time Raised'])}</td>
      <td>${esc(r['Tower'])}</td>
      <td>${esc(r['Flat'])}</td>
      <td>${esc(r['Issue'])}</td>
      <td>${esc(r['Description'])}</td>
      <td>${mediaCell(r['Media'])}</td>
      <td>${badgeStatus(statusVal)}</td>
      <td>${esc(r['Redressal Remark']||'')}</td>
      <td>${esc(r['User ID'])}</td>
      <td>${fmtDateTimeIST(r['Date & Time Resolved'])}</td>
      <td>${esc(r['Time Taken']||'')}</td>
      <td>${esc(r['Feedback']||'')}</td>
      <td>
        <div class="editgrp">
          <select id="st_${esc(tracking)}">
            <option ${/open/i.test(statusVal)?'selected':''}>Open</option>
            <option ${/in\s*progress/i.test(statusVal)?'selected':''}>InProgress</option>
            <option ${/resolved/i.test(statusVal)?'selected':''}>Resolved</option>
          </select>
          <input id="rk_${esc(tracking)}" class="remark" placeholder="Remark…" value="${esc(r['Redressal Remark']||'')}"/>
          <button class="btn primary" onclick="updateIssue('${esc(tracking)}')">Save</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('pageInfo').textContent=`Page ${page} / ${pages}`;
  document.getElementById('status').textContent = `${total} row(s), showing ${part.length}`;
}

async function updateIssue(trackingId){
  const status = document.getElementById(`st_${trackingId}`).value;
  const remark = document.getElementById(`rk_${trackingId}`).value;
  try{
    const res = await fetch(`${API}?action=updateissue&token=${encodeURIComponent(token())}`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ trackingId, status, remark })
    });
    const j = await res.json();
    if(!j.ok) throw new Error(j.error||'Failed');
    // refresh data to recompute time taken if resolved
    await fetchIssues(true);
    alert('Updated.');
  }catch(e){ alert('Update failed: '+e.message); }
}

async function fetchIssues(silent=false){
  if(!silent) document.getElementById('status').textContent='Loading…';
  const r = await fetch(`${API}?action=issues&token=${encodeURIComponent(token())}`, {cache:'no-store'});
  const j = await r.json().catch(()=>({}));
  if(!j.ok) { alert(j.error||'Auth required'); logout(); return; }
  // j.data is array of rows with sheet headers
  all = (j.data||[]).map(x=>x);
  document.getElementById('meta').textContent = `Timezone: IST • Dates shown as DD-MM-YYYY`;
  apply();
}

function attachSort(){
  document.querySelectorAll('#thead th.sort').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k=th.dataset.k;
      if(sortKey===k){ sortDir=(sortDir==='asc'?'desc':'asc'); }
      else { sortKey=k; sortDir='asc'; }
      document.querySelectorAll('#thead th.sort').forEach(x=>x.classList.remove('asc','desc'));
      th.classList.add(sortDir);
      apply();
    });
  });
}

function attachInputs(){
  ['q','f_tracking','f_raised','f_tower','f_flat','f_issue','f_desc','f_media','f_status','f_remark','f_user','f_resolved','f_taken','f_feedback']
    .forEach(id => { const el=document.getElementById(id); if(el) el.addEventListener('input', apply); });
  document.getElementById('prevBtn').addEventListener('click', ()=>{ page=Math.max(1,page-1); render(); });
  document.getElementById('nextBtn').addEventListener('click', ()=>{ page=page+1; render(); });
}

// boot
(async function init(){
  try{
    if(!token()) throw new Error('no token');
  }catch{ return logout(); }
  attachInputs();
  attachSort();
  await fetchIssues();
})();
</script>
</body>
</html>
