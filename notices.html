<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Notice Board | Global Hillview</title>

  <script>(function(){ try{ if(!localStorage.getItem('token')){ document.documentElement.style.display='none'; location.replace('/login'); } }catch{ document.documentElement.style.display='none'; location.replace('/login'); }})();</script>

  <style>
    :root{ --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --hover:#f1f5f9; --blue:#0d6efd; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;background:var(--bg);border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:28px;width:28px;border-radius:6px}
    .title{font-size:18px;font-weight:800;margin:0}
    .toolbar{display:flex;align-items:center;gap:8px}
    .userpill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card);font-weight:600}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{background:var(--hover)}
    .btn.primary{background:var(--blue);color:#fff;border-color:transparent}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid currentColor; border-right-color:transparent; display:inline-block; animation:spin .7s linear infinite }

    .wrap{padding:14px 20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input, textarea{padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-family:inherit}
    textarea{min-height:140px; width:100%; resize:vertical}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:10px;text-align:left;font-weight:700}
    tbody td{border-top:1px solid var(--border);padding:10px;vertical-align:top}
    .muted{color:var(--muted)}
    .thumb{ width:70px; height:50px; object-fit:cover; border-radius:6px; display:block; }
    .icon { width:24px; height:24px; vertical-align:middle; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="/android-chrome-512x512.png" alt="logo">
      <h1 class="title">Notice Board</h1>
    </div>
    <div class="toolbar">
      <span id="userBadge" class="userpill" style="display:none"></span>
      <button class="btn" onclick="location.href='/'">Back to Dashboard</button>
      <button class="btn danger" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Admin post area -->
    <div id="adminBar" class="card" style="display:none; margin-bottom:12px">
      <h3 style="margin:0 0 10px">Post a Notice (admins only)</h3>
      <div class="row">
        <input id="n_subject" placeholder="Subject" style="flex:2 1 260px">
        <div class="row" style="flex:1 1 260px">
          <input id="n_date" type="date" style="flex:1 1 160px">
          <input type="file" id="n_file" style="display:none">
          <button class="btn" id="attachBtn">ðŸ“Ž Attach</button>
          <span id="attachName" class="muted" style="font-size:12px"></span>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <textarea id="n_body" placeholder="Write the noticeâ€¦"></textarea>
      </div>
      <div class="row" style="margin-top:8px; align-items:center">
        <button id="n_add" class="btn primary">Post Notice</button>
        <span id="n_status" class="muted"></span>
      </div>
    </div>

    <!-- List/search -->
    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <input id="q" type="search" placeholder="Search subject/bodyâ€¦" style="min-width:260px">
        <span id="status" class="muted" style="margin-left:auto"></span>
      </div>
      <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
        <table id="grid">
          <thead><tr>
            <th style="width:90px">Serial #</th>
            <th style="width:150px">Date</th>
            <th style="width:260px">Subject</th>
            <th>Notice</th>
            <th style="width:140px">Link</th>
            <th style="width:160px">Actions</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Edit Notice modal -->
  <div id="editModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center;z-index:1000">
    <div class="card" style="max-width:680px;width:92%;">
      <h3 style="margin:0 0 10px">Edit Notice</h3>
      <input type="hidden" id="e_serial">
      <div class="row"><input id="e_date" type="date" style="flex:1 1 160px"></div>
      <div class="row" style="margin-top:8px"><input id="e_subject" placeholder="Subject" style="flex:1"></div>
      <div class="row" style="margin-top:8px"><textarea id="e_body" rows="6" style="width:100%"></textarea></div>
      <div class="row" style="margin-top:10px; justify-content:flex-end">
        <button class="btn" onclick="closeEdit()">Cancel</button>
        <button class="btn primary" id="e_save">Save</button>
      </div>
    </div>
  </div>

  <script>
    const API = '/api';
    const TOKEN = localStorage.getItem('token');
    const esc = s => String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const getTok = () => TOKEN;

    function userIcon(){ return `<svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;stroke:currentColor;display:block"><circle cx="12" cy="7.5" r="4" stroke-width="1.6"></circle><path d="M4.5 19.5a7.5 7.5 0 0115 0" stroke-width="1.6" stroke-linecap="round"></path></svg>`; }
    function setBusy(btn, on, txtIdle, txtBusy){ if(!btn) return; if(on){ btn.disabled=true; btn.innerHTML=`<span class="spinner"></span> ${txtBusy}`; }else{ btn.disabled=false; btn.textContent=txtIdle; } }
    async function apiGet(action){ const r=await fetch(`${API}?action=${encodeURIComponent(action)}&token=${encodeURIComponent(getTok())}`); const j=await r.json(); if(!j.ok) throw new Error(j.error||'Request failed'); return j.data; }
    async function apiPost(action, body){ const r=await fetch(`${API}?action=${encodeURIComponent(action)}&token=${encodeURIComponent(getTok())}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})}); const j=await r.json(); if(!j.ok) throw new Error(j.error||'Request failed'); return j.data; }
    function fileToBase64(file){ return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(String(fr.result).split(',')[1]); fr.onerror=reject; fr.readAsDataURL(file); }); }

    // icon/thumb helpers
    function extFromUrl(u){ try{ const s=new URL(u).pathname.toLowerCase(); const m=s.match(/\.([a-z0-9]+)$/i); return m?m[1]:""; }catch{return "";} }
    function driveId(u){ const m=/\/file\/d\/([A-Za-z0-9_-]+)/.exec(u||""); return m?m[1]:null; }
    function driveThumb(u){ const id=driveId(u); return id?`https://drive.google.com/thumbnail?id=${id}`:null; }
    function isImageUrl(u){ const e=extFromUrl(u); return ["png","jpg","jpeg","gif","webp","bmp","svg"].includes(e) || !!driveId(u); }
    function fileIconSvg(kind){ const map={pdf:"#d32f2f",doc:"#1976d2",docx:"#1976d2",xls:"#2e7d32",xlsx:"#2e7d32",ppt:"#ef6c00",pptx:"#ef6c00",zip:"#6d4c41",default:"#616161"}; const c=map[kind]||map.default; return `<svg class="icon" viewBox="0 0 24 24"><path fill="${c}" d="M6 2h8l6 6v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/><path fill="#fff" d="M14 2v6h6"/></svg>`; }
    function iconForUrl(u){ const e=extFromUrl(u); if(["pdf"].includes(e)) return fileIconSvg("pdf"); if(["doc","docx"].includes(e)) return fileIconSvg("doc"); if(["xls","xlsx","csv"].includes(e)) return fileIconSvg("xls"); if(["ppt","pptx"].includes(e)) return fileIconSvg("ppt"); if(["zip","rar","7z"].includes(e)) return fileIconSvg("zip"); return fileIconSvg("default"); }

    // state
    let all = [];
    let isAdmin = false;

    // extract attachment link & clean body
    function splitBodyAndLink(body){
      const lines = String(body||'').split(/\r?\n/);
      let link=null, kept=[];
      for(const ln of lines){
        const m = ln.match(/attachment:\s*(https?:\/\/\S+)/i) || ln.match(/(https?:\/\/\S+)/i);
        if(!link && m){ link=m[1]; continue; } // capture first link; drop this line from body
        kept.push(ln);
      }
      return { body: kept.join('\n').trim(), link };
    }

    function render(){
      const q = (document.getElementById('q').value||'').toLowerCase().trim();
      const tbody = document.querySelector('#grid tbody');
      tbody.innerHTML = '';
      const filtered = all.filter(r => {
        const hay = [r.subject, r.body, r.date, String(r.serial)].map(v=>String(v||'').toLowerCase()).join(' ');
        return !q || hay.includes(q);
      });
      filtered.forEach(r=>{
        const {body, link} = splitBodyAndLink(r.body);
        let linkHtml = '';
        if(link){
          const thumb = driveThumb(link);
          if(isImageUrl(link) && thumb){
            linkHtml = `<a href="${esc(link)}" target="_blank" rel="noopener"><img class="thumb" src="${esc(thumb)}" onerror="this.closest('a').innerHTML='open'"></a>`;
          }else{
            linkHtml = `<a href="${esc(link)}" target="_blank" rel="noopener">${iconForUrl(link)} open</a>`;
          }
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(r.serial)}</td>
          <td>${esc(r.date)}</td>
          <td>${esc(r.subject)}</td>
          <td style="white-space:pre-wrap">${esc(body)}</td>
          <td>${linkHtml}</td>
          <td>
            ${isAdmin ? `
              <button class="btn" data-act="edit" data-serial="${r.serial}">Edit</button>
              <button class="btn danger" data-act="del" data-serial="${r.serial}">Delete</button>` : ``}
          </td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('status').textContent = `Loaded ${all.length} notice(s)`;
    }

    async function fetchNotices(){
      document.getElementById('status').textContent = 'Loadingâ€¦';
      const list = await apiGet('notices'); // [{serial,subject,date,body}]
      all = (list||[]).sort((a,b)=>{
        const ad = new Date(a.date||0).getTime(), bd = new Date(b.date||0).getTime();
        if(ad!==bd) return bd-ad; return (b.serial||0)-(a.serial||0);
      });
      render();
    }

    async function addNotice(){
      const btn = document.getElementById('n_add');
      const s = document.getElementById('n_status');
      const subject = document.getElementById('n_subject').value.trim();
      const date = document.getElementById('n_date').value;
      const body = document.getElementById('n_body').value.trim();
      if(!subject || !body){ s.textContent = 'Subject and notice text are required.'; return; }
      setBusy(btn, true, 'Post Notice', 'Postingâ€¦'); s.textContent = '';
      try{
        await apiPost('addnotice', { subject, date, body });
        document.getElementById('n_subject').value = '';
        document.getElementById('n_body').value = '';
        document.getElementById('attachName').textContent = '';
        s.textContent = 'Posted.'; await fetchNotices();
      }catch(e){ s.textContent = 'Failed to post.'; }
      finally{ setBusy(btn, false, 'Post Notice', 'Postingâ€¦'); }
    }

    // ðŸ“Ž Attach â†’ upload then append â€œAttachment: <url>â€ to body
    document.getElementById('attachBtn').addEventListener('click', ()=> document.getElementById('n_file').click());
    document.getElementById('n_file').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const btn = document.getElementById('attachBtn'); const nameEl = document.getElementById('attachName');
      try{
        setBusy(btn, true, 'ðŸ“Ž Attach', 'Uploadingâ€¦');
        const b64 = await fileToBase64(f);
        const up = await apiPost('uploaddocb64', { name:f.name, mime:f.type, data:b64 }); // {url}
        const ta = document.getElementById('n_body');
        const sep = ta.value ? '\n\n' : '';
        ta.value = ta.value + sep + `Attachment: ${up.url}`;
        nameEl.textContent = f.name;
      }catch(err){ alert('Upload failed: ' + err.message); }
      finally{ setBusy(btn, false, 'ðŸ“Ž Attach', 'Uploadingâ€¦'); }
    });

    // table actions (edit/delete)
    document.querySelector('#grid tbody').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]'); if(!btn) return;
      const serial = Number(btn.dataset.serial);
      const row = all.find(r=>Number(r.serial)===serial); if(!row) return;
      if(btn.dataset.act==='del'){
        if(!confirm('Delete this notice?')) return;
        await apiPost('deletenotice', { serial });
        await fetchNotices();
      }else{
        document.getElementById('e_serial').value = serial;
        document.getElementById('e_date').value = (row.date||'').substring(0,10);
        document.getElementById('e_subject').value = row.subject||'';
        document.getElementById('e_body').value = row.body||'';
        document.getElementById('editModal').style.display='flex';
      }
    });

    document.getElementById('e_save').addEventListener('click', async ()=>{
      const serial = Number(document.getElementById('e_serial').value);
      const subject = document.getElementById('e_subject').value.trim();
      const body = document.getElementById('e_body').value.trim();
      const date = document.getElementById('e_date').value||undefined;
      if(!subject || !body) return alert('Subject and body required');
      await apiPost('updatenotice', { serial, subject, body, date });
      closeEdit(); fetchNotices();
    });
    function closeEdit(){ document.getElementById('editModal').style.display='none'; }

    (async function init(){
      // whoami
      try{
        const me = await apiGet('whoami');
        isAdmin = (me.user?.role==='admin');
        const ub = document.getElementById('userBadge');
        if(ub){ ub.style.display='inline-flex'; ub.innerHTML = `${userIcon()}<span>${esc(me.user?.username||'')}</span>`; }
        if(isAdmin){
          document.getElementById('adminBar').style.display = 'block';
          document.getElementById('n_date').valueAsDate = new Date();
          document.getElementById('n_add').addEventListener('click', addNotice);
        }
      }catch{ location.replace('/login'); return; }

      document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('token'); location.replace('/login'); });
      document.getElementById('q').addEventListener('input', render);
      await fetchNotices();
    })();
  </script>
</body>
</html>
