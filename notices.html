<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Notice Board</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f8fb; }
    .container-xl { max-width: 1200px; }
    .card { border-radius: 14px; }
    .table td, .table th { vertical-align: middle; }
    .cursor-pointer { cursor: pointer; }
  </style>
</head>
<body>
  <nav class="navbar bg-white border-bottom mb-3">
    <div class="container-xl">
      <a class="navbar-brand d-flex align-items-center gap-2" href="#">
        <img src="/logo.png" alt="Logo" height="28" onerror="this.style.display='none'"/>
        <span class="fw-semibold">Notice Board</span>
      </a>
      <div class="d-flex align-items-center gap-2">
        <a href="/dashboard" class="btn btn-outline-secondary btn-sm">Back to Dashboard</a>
        <button class="btn btn-danger btn-sm" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container-xl pb-5">
    <!-- Post a notice -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Post a Notice (admins only)</h5>
        <div class="row g-3 align-items-start">
          <div class="col-md-6">
            <input id="noticeSubject" class="form-control" placeholder="Subject"/>
          </div>
          <div class="col-md-6">
            <div class="d-flex align-items-center gap-2">
              <input id="noticeDate" class="form-control" placeholder="dd - mm - yyyy" />
              <!-- Attach -->
              <input type="file" id="noticeFile" style="display:none" />
              <button type="button" id="attachBtn" class="btn btn-outline-secondary">ðŸ“Ž Attach</button>
              <span id="noticeFileName" class="text-muted small"></span>
            </div>
          </div>
          <div class="col-12">
            <textarea id="noticeBody" rows="5" class="form-control" placeholder="Write the notice..."></textarea>
            <div id="noticeAttachmentPreview" class="small text-muted mt-2" style="display:none;">
              Attached: <a id="noticeAttachmentLink" href="#" target="_blank" rel="noopener">view</a>
            </div>
          </div>
          <div class="col-12">
            <button class="btn btn-primary" id="postNoticeBtn">Post Notice</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Filter + table -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <input id="noticeSearch" class="form-control" style="max-width:340px" placeholder="Search subject/body..."/>
          <div class="text-muted small" id="noticeCount"></div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th style="width:90px">Serial #</th>
                <th style="width:180px">Date</th>
                <th style="width:280px">Subject</th>
                <th>Notice</th>
                <th style="width:160px">Actions</th>
              </tr>
            </thead>
            <tbody id="noticesTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Notice Modal -->
  <div class="modal fade" id="editNoticeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Notice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editNoticeSerial">
          <div class="mb-3">
            <label class="form-label">Date</label>
            <input id="editNoticeDate" class="form-control" placeholder="yyyy-mm-dd">
          </div>
          <div class="mb-3">
            <label class="form-label">Subject</label>
            <input id="editNoticeSubject" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Body</label>
            <textarea id="editNoticeBody" rows="5" class="form-control"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="saveNoticeEditBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const API_BASE = ''; // <-- set your Apps Script URL, e.g. "https://script.google.com/macros/s/XXXXXXXX/exec"
    const TOKEN = localStorage.getItem('enviro_token');

    /* ===== Utilities ===== */
    const qs  = (s, r=document)=>r.querySelector(s);
    const qsa = (s, r=document)=>Array.from(r.querySelectorAll(s));
    function escapeHtml(s) { return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function assertToken() { if(!TOKEN) { alert('Not logged in'); location.href='/'; } }
    async function apiGet(action) {
      const res = await fetch(`${API_BASE}?action=${encodeURIComponent(action)}&token=${encodeURIComponent(TOKEN)}`);
      const json = await res.json();
      if(!json.ok) throw new Error(json.error||'Request failed');
      return json.data;
    }
    async function apiPost(action, body) {
      const res = await fetch(`${API_BASE}?action=${encodeURIComponent(action)}&token=${encodeURIComponent(TOKEN)}`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body||{})
      });
      const json = await res.json();
      if(!json.ok) throw new Error(json.error||'Request failed');
      return json.data;
    }
    function fileToBase64(file) {
      return new Promise((resolve, reject)=>{
        const r=new FileReader();
        r.onload=()=>resolve(String(r.result).split(',')[1]);
        r.onerror=reject;
        r.readAsDataURL(file);
      });
    }
    async function uploadB64ToDrive(file) {
      const b64 = await fileToBase64(file);
      return apiPost('uploaddocb64', { name:file.name, mime:file.type, data:b64 }); // {id,name,url,mimeType}
    }

    /* ===== Attach (upload) wiring ===== */
    const noticeFile  = qs('#noticeFile');
    const attachBtn   = qs('#attachBtn');
    const fileNameEl  = qs('#noticeFileName');
    const attachPrev  = qs('#noticeAttachmentPreview');
    const attachLink  = qs('#noticeAttachmentLink');

    attachBtn.addEventListener('click', ()=> noticeFile.click());
    noticeFile.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      fileNameEl.textContent = f.name;
      attachBtn.disabled = true; attachBtn.textContent = 'Uploading...';
      try {
        const up = await uploadB64ToDrive(f);
        const ta = qs('#noticeBody');
        const sep = ta.value ? '\n\n' : '';
        ta.value = ta.value + sep + `Attachment: ${up.url}`;
        attachLink.href = up.url; attachPrev.style.display = '';
      } catch(err) { alert('Upload failed: ' + err.message); }
      finally { attachBtn.disabled = false; attachBtn.textContent = 'ðŸ“Ž Attach'; }
    });

    /* ===== Create notice ===== */
    qs('#postNoticeBtn').addEventListener('click', async ()=>{
      try{
        const subject = qs('#noticeSubject').value.trim();
        const body    = qs('#noticeBody').value.trim();
        const dateStr = qs('#noticeDate').value.trim(); // optional
        if(!subject || !body) return alert('Subject and body are required');
        await apiPost('addnotice', { subject, body, date: dateStr||undefined });
        qs('#noticeSubject').value=''; qs('#noticeBody').value=''; qs('#noticeDate').value='';
        fileNameEl.textContent=''; attachPrev.style.display='none';
        loadNotices();
      }catch(err){ alert(err.message); }
    });

    /* ===== List / search / actions ===== */
    let ALL_NOTICES = [];
    async function loadNotices(){
      assertToken();
      const list = await apiGet('notices'); // [{serial,subject,date,body}]
      ALL_NOTICES = list.sort((a,b)=> Number(b.serial)-Number(a.serial));
      renderNotices();
    }
    function renderNotices(){
      const q = qs('#noticeSearch').value.trim().toLowerCase();
      const rows = !q ? ALL_NOTICES : ALL_NOTICES.filter(n =>
        (n.subject||'').toLowerCase().includes(q) || (n.body||'').toLowerCase().includes(q)
      );
      qs('#noticeCount').textContent = `Loaded ${rows.length} notice(s)`;
      const tb = qs('#noticesTableBody'); tb.innerHTML='';
      rows.forEach(n=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${n.serial}</td>
          <td>${escapeHtml(n.date||'')}</td>
          <td>${escapeHtml(n.subject||'')}</td>
          <td style="white-space:pre-wrap">${escapeHtml(n.body||'')}</td>
          <td class="text-nowrap">
            <button class="btn btn-sm btn-outline-primary me-1" data-action="edit" data-serial="${n.serial}">Edit</button>
            <button class="btn btn-sm btn-outline-danger" data-action="delete" data-serial="${n.serial}">Delete</button>
          </td>
        `;
        tb.appendChild(tr);
      });
    }
    qs('#noticeSearch').addEventListener('input', renderNotices);

    // delegate actions
    qs('#noticesTableBody').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      const serial = Number(btn.dataset.serial);
      const n = ALL_NOTICES.find(x=>Number(x.serial)===serial);
      if(!n) return;

      if(btn.dataset.action==='delete'){
        if(!confirm('Delete this notice?')) return;
        try { await apiPost('deletenotice', { serial }); loadNotices(); }
        catch(err){ alert('Delete failed: ' + err.message); }
      } else if(btn.dataset.action==='edit') {
        qs('#editNoticeSerial').value = serial;
        qs('#editNoticeDate').value = (n.date||'');
        qs('#editNoticeSubject').value = (n.subject||'');
        qs('#editNoticeBody').value = (n.body||'');
        const m = bootstrap.Modal.getOrCreateInstance(qs('#editNoticeModal')); m.show();
      }
    });

    // save edit
    qs('#saveNoticeEditBtn').addEventListener('click', async ()=>{
      const serial = Number(qs('#editNoticeSerial').value);
      const date   = qs('#editNoticeDate').value.trim() || undefined;
      const subject= qs('#editNoticeSubject').value.trim();
      const body   = qs('#editNoticeBody').value.trim();
      if(!subject || !body){ alert('Subject and body required'); return; }
      try{
        await apiPost('updatenotice', { serial, subject, body, date });
        bootstrap.Modal.getInstance(qs('#editNoticeModal')).hide();
        loadNotices();
      }catch(err){ alert('Update failed: ' + err.message); }
    });

    qs('#logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('enviro_token'); location.href='/'; });

    // init
    document.addEventListener('DOMContentLoaded', loadNotices);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
