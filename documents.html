<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Document Repository</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: Arial, sans-serif; background:#f7f9fc; margin:0; }
  header { background:#fff; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #ddd; }
  header img { height:40px; }
  header h2 { margin:0; color:#123; }
  .btn { padding:6px 12px; border:none; border-radius:5px; cursor:pointer; font-size:14px; }
  .btn.primary { background:#007bff; color:#fff; }
  .btn.danger { background:#dc3545; color:#fff; }
  .btn.secondary { background:#6c757d; color:#fff; }
  .container { padding:20px; }
  .search { margin-bottom:15px; }
  .search input { padding:8px; width:100%; max-width:300px; border:1px solid #ccc; border-radius:6px; }
  table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
  th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
  th { background:#f1f3f6; font-weight:bold; }
  tr:hover { background:#f9fafc; }
  .thumb { width:80px; height:auto; border-radius:5px; }
  /* Modal */
  .modal { display:none; position:fixed; z-index:1000; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; }
  .modal-content { background:#fff; padding:20px; border-radius:8px; max-width:500px; width:90%; }
  .modal-content h3 { margin-top:0; }
  .modal-content label { display:block; margin-top:10px; }
  .modal-content input { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
  .modal-actions { margin-top:15px; display:flex; gap:10px; justify-content:flex-end; }
</style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center; gap:10px;">
    <img src="logo.png" alt="Logo">
    <h2>Document Repository</h2>
  </div>
  <div>
    <button class="btn secondary" onclick="window.location.href='/dashboard'">Back to Dashboard</button>
    <button class="btn danger" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">
  <div class="search">
    <input type="text" id="searchBox" placeholder="Search subject...">
    <button id="addDocBtn" class="btn primary" style="display:none; margin-left:10px;">+ Add Document</button>
  </div>

  <table id="docsTable">
    <thead>
      <tr>
        <th>Serial #</th>
        <th>Date</th>
        <th>Subject</th>
        <th>Media</th>
        <th>Link</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Add/Edit Modal -->
<div class="modal" id="docModal">
  <div class="modal-content">
    <h3 id="modalTitle">Add Document</h3>
    <form id="docForm">
      <input type="hidden" id="docSerial">
      <label>Date <input type="date" id="docDate" required></label>
      <label>Subject <input type="text" id="docSubject" required></label>
      <label>Media URL <input type="url" id="docMedia"></label>
      <label>Link URL <input type="url" id="docLink"></label>
      <div class="modal-actions">
        <button type="button" class="btn secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec"; // replace with your Apps Script endpoint
let docs = [];
let admin = true; // toggle based on user role check

// --- Utility ---
function logout(){ localStorage.clear(); window.location.href="/login"; }
function esc(s){ return (s||'').toString().replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

// --- Modal controls ---
const modal = document.getElementById("docModal");
function openModal(edit=false, data=null){
  modal.style.display="flex";
  document.getElementById("modalTitle").textContent = edit ? "Edit Document" : "Add Document";
  if(edit && data){
    document.getElementById("docSerial").value = data.serial;
    document.getElementById("docDate").value = data.date;
    document.getElementById("docSubject").value = data.subject;
    document.getElementById("docMedia").value = data.media;
    document.getElementById("docLink").value = data.link;
  } else {
    document.getElementById("docForm").reset();
    document.getElementById("docSerial").value = "";
  }
}
function closeModal(){ modal.style.display="none"; }

// --- API Calls ---
async function fetchDocs(){
  try{
    const res = await fetch(`${API}?action=list`);
    const j = await res.json();
    docs = j.docs || [];
    render();
  }catch(e){ console.error("Fetch failed", e); }
}
async function saveDoc(ev){
  ev.preventDefault();
  const payload = {
    serial: document.getElementById("docSerial").value,
    date: document.getElementById("docDate").value,
    subject: document.getElementById("docSubject").value,
    media: document.getElementById("docMedia").value,
    link: document.getElementById("docLink").value
  };
  const action = payload.serial ? "update" : "add";
  try{
    await fetch(`${API}?action=${action}`, {method:"POST", body:JSON.stringify(payload)});
    closeModal(); fetchDocs();
  }catch(e){ alert("Save failed"); }
}
async function deleteDoc(serial){
  if(!confirm("Delete document #"+serial+"?")) return;
  try{
    await fetch(`${API}?action=delete`, {method:"POST", body:JSON.stringify({serial})});
    fetchDocs();
  }catch(e){ alert("Delete failed"); }
}

// --- Rendering ---
function mediaCell(url){
  if(!url) return "";
  return `<a href="${esc(url)}" target="_blank"><img src="${esc(url)}" class="thumb"></a>`;
}
function render(){
  const q = document.getElementById("searchBox").value.toLowerCase();
  const tbody = document.querySelector("#docsTable tbody");
  tbody.innerHTML="";
  docs.filter(d=>!q || d.subject.toLowerCase().includes(q)).forEach(d=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${esc(d.serial)}</td>
      <td>${esc(d.date)}</td>
      <td>${esc(d.subject)}</td>
      <td>${mediaCell(d.media)}</td>
      <td>${d.link ? `<a href="${esc(d.link)}" target="_blank">Open</a>` : ""}</td>
      <td>
        ${admin? `
          <button class="btn secondary" onclick='openModal(true, ${JSON.stringify(d)})'>Edit</button>
          <button class="btn danger" onclick="deleteDoc('${d.serial}')">Delete</button>
        `:""}
      </td>`;
    tbody.appendChild(tr);
  });
}

// --- Init ---
document.getElementById("docForm").addEventListener("submit", saveDoc);
document.getElementById("searchBox").addEventListener("input", render);
document.getElementById("addDocBtn").addEventListener("click", ()=>openModal(false));
if(admin) document.getElementById("addDocBtn").style.display="inline-block";
fetchDocs();
</script>
</body>
</html>
