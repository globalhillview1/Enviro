<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Document Repository | Global Hillview</title>

  <!-- Favicons (optional) -->
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- No-paint guard -->
  <script>
    (function(){ try{ if(!localStorage.getItem('token')){ document.documentElement.style.display='none'; location.replace('/login'); } }catch{ document.documentElement.style.display='none'; location.replace('/login'); }})();
  </script>

  <style>
    :root{ --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --hover:#f1f5f9; --blue:#0d6efd; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;background:var(--bg);border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:28px;width:28px;border-radius:6px}
    .title{font-size:18px;font-weight:800;margin:0}
    .toolbar{display:flex;align-items:center;gap:8px}
    .userpill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card);font-weight:600}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{background:var(--hover)}
    .btn.primary{background:var(--blue);color:#fff;border-color:transparent}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid currentColor; border-right-color:transparent; display:inline-block; animation:spin .7s linear infinite }
    .wrap{padding:14px 20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input{padding:10px 12px;border:1px solid var(--border);border-radius:10px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:10px;text-align:left;font-weight:700}
    tbody td{border-top:1px solid var(--border);padding:10px;vertical-align:top}
    .muted{color:var(--muted)}
    .thumb{max-width:68px;max-height:68px;border-radius:8px;border:1px solid var(--border)}
    .filechip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--card);font-size:12px}
  </style>
</head>
<body>
  <!-- hidden picker -->
  <input id="pickFile" type="file" style="display:none" />

  <header>
    <div class="brand">
      <img src="/android-chrome-512x512.png" alt="logo">
      <h1 class="title">Document Repository</h1>
    </div>
    <div class="toolbar">
      <span id="userBadge" class="userpill" style="display:none"></span>
      <button class="btn" onclick="location.href='/'">Back to Dashboard</button>
      <button class="btn danger" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <!-- Admin Panel -->
    <div id="adminBar" class="card" style="display:none; margin-bottom:12px">
      <div class="row" style="align-items:center">
        <button id="btnPick" class="btn primary">Upload to Drive</button>
        <span class="muted">Pick a file from your computer. It will upload to the shared Drive folder and the link will be recorded below.</span>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="d_subject" placeholder="Subject" style="flex:2 1 260px">
        <input id="d_date" type="date" style="flex:1 1 160px">
        <input id="d_media" placeholder="Media (auto-filled on upload)" style="flex:2 1 260px">
        <input id="d_url" placeholder="Document URL (share link ‚Äì optional)" style="flex:2 1 260px">
      </div>
      <div class="row" style="margin-top:8px">
        <button id="d_add" class="btn">Add entry</button>
        <span id="d_status" class="muted"></span>
      </div>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <input id="q" type="search" placeholder="Search subject‚Ä¶" style="min-width:260px">
        <span id="status" class="muted" style="margin-left:auto"></span>
      </div>

      <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
        <table id="grid">
          <thead><tr>
            <th style="width:80px">Serial #</th>
            <th style="width:160px">Date</th>
            <th>Subject</th>
            <th style="width:120px">Media</th>
            <th style="width:120px">Link</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Embedded folder (read-only) -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 10px">Drive Folder</h3>
      <iframe id="driveEmbed" src="" style="width:100%;height:480px;border:0;border-radius:12px"></iframe>
      <div class="muted" style="margin-top:8px">
        If you see a permission prompt, ensure the folder is shared for viewing (‚ÄúAnyone with the link ‚Üí Viewer‚Äù). Only admins should have upload permission.
      </div>
    </div>
  </div>

  <script>
    /* ===== Config & utils ===== */
    const API = '/api';
    const SHEET_ID  = '1mTEgG-bjumtytA3oHFyF0U1Mh5XjYoJx2BolcIuSuBk';
    const SHEET_TAB = 'Documents';
    const DRIVE_FOLDER_ID = '1lFHxYeF3z73Zn75sRU0aG12tT93JGDjN';

    const esc = s => String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const getTok = () => { try{ return localStorage.getItem('token'); }catch{ return null; } };
    const isAdmin = () => (localStorage.getItem('role') === 'admin');

    function setUploadBusy(on){
      const btn = document.getElementById('btnPick');
      if(!btn) return;
      if(on){
        btn.disabled = true;
        btn.dataset._w = btn.offsetWidth;
        btn.style.minWidth = btn.dataset._w + 'px';
        btn.innerHTML = '<span class="spinner" aria-hidden="true"></span> Uploading‚Ä¶';
      }else{
        btn.disabled = false;
        btn.style.minWidth = '';
        btn.innerHTML = 'Upload to Drive';
      }
    }

    // Extract Drive file id from /file/d/<id>/... or ?id=<id>
    function extractDriveId(u=''){
      try{
        const m1 = String(u).match(/\/file\/d\/([^/]+)/i);
        if(m1) return m1[1];
        const url = new URL(u);
        if(url.searchParams.get('id')) return url.searchParams.get('id');
      }catch{}
      return '';
    }
    // Prefer a viewable URL for img/video tags
    function driveViewUrl(u){
      const id = extractDriveId(u);
      return id ? `https://drive.google.com/uc?id=${id}&export=view` : u;
    }

    (function initChrome(){
      const name = localStorage.getItem('username')||'';
      const ub = document.getElementById('userBadge');
      if (name && ub){
        ub.style.display='inline-flex';
        ub.innerHTML = `<svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;stroke:currentColor;display:block"><circle cx="12" cy="7.5" r="4" stroke-width="1.6"></circle><path d="M4.5 19.5a7.5 7.5 0 0115 0" stroke-width="1.6" stroke-linecap="round"></path></svg><span>${esc(name)}</span>`;
      }
      document.getElementById('logoutBtn').addEventListener('click', ()=>{
        const btn = document.getElementById('logoutBtn');
        btn.disabled = true; btn.style.minWidth = btn.offsetWidth + 'px';
        btn.innerHTML = '<span class="spinner"></span> Logging out‚Ä¶';
        try{ localStorage.removeItem('token'); localStorage.removeItem('role'); localStorage.removeItem('username'); }catch{}
        setTimeout(()=>location.replace('/login'), 600);
      });
      if (isAdmin()){
        document.getElementById('adminBar').style.display = 'block';
        document.getElementById('d_date').valueAsDate = new Date();
      }
      document.getElementById('driveEmbed').src = `https://drive.google.com/embeddedfolderview?id=${encodeURIComponent(DRIVE_FOLDER_ID)}#grid`;
    })();

    /* ===== Upload flow (admin) ===== */
    document.getElementById('btnPick')?.addEventListener('click', ()=> document.getElementById('pickFile').click());

    document.getElementById('pickFile')?.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      setUploadBusy(true);
      try{
        const fd = new FormData();
        fd.append('file', file);

        const res = await fetch(`/api?action=uploaddoc&token=${encodeURIComponent(getTok())}`, {
          method: 'POST',
          body: fd
        });
        const json = await res.json();

        if (!json.ok) throw new Error(json.error || 'Upload failed');

        // Autofill subject + media with the uploaded file link
        const subjectEl = document.getElementById('d_subject');
        const mediaEl   = document.getElementById('d_media');
        if (subjectEl && !subjectEl.value) subjectEl.value = json.data.name || file.name;

        // Prefer a viewable link for previews in the table
        mediaEl.value = driveViewUrl(json.data.url || '');

        // Focus subject so admin can review then click "Add entry"
        subjectEl.focus();
      }catch(err){
        alert('Upload error: ' + err.message);
      }finally{
        setUploadBusy(false);
        e.target.value = '';
      }
    });

    /* ===== Fetch & render ===== */
    async function fetchDocs(){
      const status = document.getElementById('status');
      status.textContent = 'Loading‚Ä¶';

      // gviz read
      const url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/gviz/tq?sheet=${encodeURIComponent(SHEET_TAB)}&tqx=out:json`;
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      const a = text.indexOf('{'), b = text.lastIndexOf('}');
      const json = JSON.parse(text.slice(a,b+1));

      const cols = json.table.cols.map(c => (c.label||c.id||'').trim());
      const rows = (json.table.rows||[]).map(r => (r.c||[]).map(c => c ? c.v : ''));

      // map headers
      const idx = {
        serial:  cols.findIndex(x=>/^serial/i.test(x)),
        subject: cols.findIndex(x=>/^subject/i.test(x)),
        date:    cols.findIndex(x=>/^date$/i.test(x)),
        media:   cols.findIndex(x=>/^media$/i.test(x)),
        url:     cols.findIndex(x=>/^(url|link)$/i.test(x)),
      };

      const data = rows.map(r => ({
        serial: r[idx.serial] ?? '',
        subject: r[idx.subject] ?? '',
        date: r[idx.date] ?? '',
        media: r[idx.media] ?? '',
        url: r[idx.url] ?? ''
      })).filter(r => r.subject || r.media || r.url);

      status.textContent = `Loaded ${data.length} document(s)`;
      return data;
    }

    function fileIconByExt(url=''){
      const u = url.toLowerCase();
      if (u.endsWith('.pdf')) return 'üìÑ PDF';
      if (u.endsWith('.doc') || u.endsWith('.docx') || u.endsWith('.odt')) return 'üìù Word';
      if (u.endsWith('.xls') || u.endsWith('.xlsx') || u.endsWith('.ods')) return 'üìä Excel';
      if (u.endsWith('.ppt') || u.endsWith('.pptx') || u.endsWith('.odp')) return 'üìΩÔ∏è PPT';
      return 'üìÅ File';
    }

    function canImg(url=''){ return /\.(jpe?g|png|gif|webp|bmp|svg)$/i.test(url) || /google\.com\/(uc|thumbnail)/.test(url); }
    function canVideo(url=''){ return /\.(mp4|webm|mov|m4v)$/i.test(url); }

    let all = [];
    function render(){
      const q = (document.getElementById('q').value||'').toLowerCase().trim();
      const tbody = document.querySelector('#grid tbody');
      tbody.innerHTML = '';

      const filtered = all.filter(r =>
        !q || [r.subject,r.date,String(r.serial)].some(v => String(v||'').toLowerCase().includes(q))
      );

      filtered.forEach(r=>{
        const tr = document.createElement('tr');

        // Media cell
        let mediaCell = '';
        if (r.media){
          const murl = driveViewUrl(r.media);
          if (canImg(murl)){
            mediaCell = `<img class="thumb" src="${esc(murl)}" alt="media">`;
          } else if (canVideo(murl)){
            mediaCell = `<video class="thumb" src="${esc(murl)}" controls></video>`;
          } else {
            mediaCell = `<span class="filechip">${fileIconByExt(murl)}</span>`;
          }
        }

        // Link cell (= only manual URL column)
        let linkCell = '';
        if (r.url){
          linkCell = `<a href="${esc(r.url)}" target="_blank" rel="noopener">Open</a>`;
        }

        tr.innerHTML = `
          <td>${esc(r.serial)}</td>
          <td>${esc(r.date)}</td>
          <td>${esc(r.subject)}</td>
          <td>${mediaCell}</td>
          <td>${linkCell}</td>`;
        tbody.appendChild(tr);
      });
    }

    document.getElementById('q').addEventListener('input', render);

    // Add entry to sheet
    document.getElementById('d_add')?.addEventListener('click', async ()=>{
      if(!isAdmin()) return;
      const subject = document.getElementById('d_subject').value.trim();
      const date    = document.getElementById('d_date').value;
      const media   = document.getElementById('d_media').value.trim(); // uploaded file URL
      const url     = document.getElementById('d_url').value.trim();   // optional manual link
      const s       = document.getElementById('d_status');

      if(!subject || !date){ s.textContent = 'Fill subject and date (media or url optional).'; return; }
      s.textContent = 'Adding‚Ä¶';
      try{
        const res = await fetch(`${API}?action=adddoc&token=${encodeURIComponent(getTok())}`,{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ subject, date, media, url })
        });
        const j = await res.json().catch(()=>({}));
        if(!j.ok) throw new Error(j.error || 'Failed');
        s.textContent = 'Added.';
        document.getElementById('d_subject').value='';
        document.getElementById('d_media').value='';
        document.getElementById('d_url').value='';
        all = await fetchDocs(); render();
      }catch(e){ s.textContent = 'Failed to add (check /api?action=adddoc).'; }
    });

    (async function init(){
      try{ all = await fetchDocs(); render(); }
      catch(e){ document.getElementById('status').textContent = 'Failed to load (publish sheet or check IDs)'; }
    })();
  </script>
</body>
</html>
