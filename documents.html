<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Document Repository | Global Hillview</title>

Â  <!-- Favicons -->
Â  <link rel="alternate icon" href="/favicon.ico">
Â  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
Â  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
Â  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
Â  <link rel="manifest" href="/site.webmanifest">

Â  <!-- No-paint guard if not logged in -->
Â  <script>
Â  Â  (function () {
Â  Â  Â  try {
Â  Â  Â  Â  if (!localStorage.getItem('token')) {
Â  Â  Â  Â  Â  document.documentElement.style.display = 'none';
Â  Â  Â  Â  Â  location.replace('/login');
Â  Â  Â  Â  }
Â  Â  Â  } catch {
Â  Â  Â  Â  document.documentElement.style.display = 'none';
Â  Â  Â  Â  location.replace('/login');
Â  Â  Â  }
Â  Â  })();
Â  </script>

Â  <style>
Â  Â  :root{ --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --hover:#f1f5f9; --blue:#0d6efd; --danger:#ef4444; }
Â  Â  *{box-sizing:border-box}
Â  Â  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";background:var(--bg);color:var(--text)}
Â  Â  header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;background:var(--bg);border-bottom:1px solid var(--border)}
Â  Â  .brand{display:flex;align-items:center;gap:10px}
Â  Â  .brand img{height:28px;width:28px;border-radius:6px}
Â  Â  .title{font-size:18px;font-weight:800;margin:0}
Â  Â  .toolbar{display:flex;align-items:center;gap:8px}
Â  Â  .userpill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card);font-weight:600}
Â  Â  .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
Â  Â  .btn:hover{background:var(--hover)}
Â  Â  .btn.primary{background:var(--blue);color:#fff;border-color:transparent}
Â  Â  .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
Â  Â  @keyframes spin { to { transform: rotate(360deg); } }
Â  Â  .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid currentColor; border-right-color:transparent; display:inline-block; animation:spin .7s linear infinite }
Â  Â  .wrap{padding:14px 20px}
Â  Â  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
Â  Â  .row{display:flex;gap:8px;flex-wrap:wrap}
Â  Â  input{padding:10px 12px;border:1px solid var(--border);border-radius:10px}
Â  Â  table{width:100%;border-collapse:separate;border-spacing:0}
Â  Â  thead th{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:10px;text-align:left;font-weight:700}
Â  Â  tbody td{border-top:1px solid var(--border);padding:10px;vertical-align:top}
Â  Â  .muted{color:var(--muted)}
Â  Â  .thumb{max-width:64px;max-height:64px;object-fit:cover;border-radius:6px;border:1px solid var(--border)}
Â  </style>
</head>
<body>
Â  <!-- hidden file picker -->
Â  <input id="pickFile" type="file" style="display:none" />

Â  <header>
Â  Â  <div class="brand">
Â  Â  Â  <img src="/android-chrome-512x512.png" alt="logo">
Â  Â  Â  <h1 class="title">Document Repository</h1>
Â  Â  </div>
Â  Â  <div class="toolbar">
Â  Â  Â  <span id="userBadge" class="userpill" style="display:none"></span>
Â  Â  Â  <button class="btn" onclick="location.href='/'">Back to Dashboard</button>
Â  Â  Â  <button class="btn danger" id="logoutBtn">Logout</button>
Â  Â  </div>
Â  </header>

Â  <div class="wrap">
Â  Â  <!-- Admin controls -->
Â  Â  <div id="adminBar" class="card" style="display:none; margin-bottom:12px">
Â  Â  Â  <div class="row" style="align-items:center">
Â  Â  Â  Â  <button id="btnPick" class="btn primary">Upload to Drive</button>
Â  Â  Â  Â  <span class="muted">Pick a file; it uploads to the shared Drive and its link is captured below.</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="row" style="margin-top:8px">
Â  Â  Â  Â  <input id="d_subject" placeholder="Subject" style="flex:2 1 260px">
Â  Â  Â  Â  <input id="d_date" type="date" style="flex:1 1 160px">
Â  Â  Â  Â  <input id="d_url" placeholder="Document URL (share link or uploaded file URL)" style="flex:2 1 260px">
Â  Â  Â  </div>
Â  Â  Â  <div class="row" style="margin-top:8px">
Â  Â  Â  Â  <button id="d_add" class="btn">Add entry</button>
Â  Â  Â  Â  <span id="d_status" class="muted"></span>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Grid -->
Â  Â  <div class="card">
Â  Â  Â  <div class="row" style="margin-bottom:8px">
Â  Â  Â  Â  <input id="q" type="search" placeholder="Search subjectâ€¦" style="min-width:260px">
Â  Â  Â  Â  <span id="status" class="muted" style="margin-left:auto"></span>
Â  Â  Â  </div>

Â  Â  Â  <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
Â  Â  Â  Â  <table id="grid">
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th style="width:80px">Serial #</th>
Â  Â  Â  Â  Â  Â  <th style="width:160px">Date</th>
Â  Â  Â  Â  Â  Â  <th>Subject</th>
Â  Â  Â  Â  Â  Â  <th>Media</th>
Â  Â  Â  Â  Â  Â  <th>Link</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script>
Â  Â  /* ----- CONFIG ----- */
Â  Â  const API = '/api';
Â  Â  const SHEET_IDÂ  = '1mTEgG-bjumtytA3oHFyF0U1Mh5XjYoJx2BolcIuSuBk';
Â  Â  const SHEET_TAB = 'Documents';

Â  Â  /* ----- UTILS ----- */
Â  Â  const esc = (s) => String(s ?? '')
Â  Â  Â  .replace(/&/g,'&amp;').replace(/</g,'&lt;')
Â  Â  Â  .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
Â  Â  const getTok = () => { try { return localStorage.getItem('token'); } catch { return null; } };
Â  Â  const isAdmin = () => (localStorage.getItem('role') === 'admin');

Â  Â  // UX bits
Â  Â  function userIcon(){ return `<svg viewBox="0 0 24 24" fill="none" style="width:16px;height:16px;stroke:currentColor;display:block"><circle cx="12" cy="7.5" r="4" stroke-width="1.6"></circle><path d="M4.5 19.5a7.5 7.5 0 0115 0" stroke-width="1.6" stroke-linecap="round"></path></svg>`; }
Â  Â  function setUploadBusy(on){
Â  Â  Â  const btn = document.getElementById('btnPick');
Â  Â  Â  if (!btn) return;
Â  Â  Â  if (on){
Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  btn.dataset._w = btn.offsetWidth;
Â  Â  Â  Â  btn.style.minWidth = btn.dataset._w + 'px';
Â  Â  Â  Â  btn.innerHTML = '<span class="spinner" aria-hidden="true"></span> Uploadingâ€¦';
Â  Â  Â  } else {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.style.minWidth = '';
Â  Â  Â  Â  btn.innerHTML = 'Upload to Drive';
Â  Â  Â  }
Â  Â  }

Â  Â  // Header chrome
Â  Â  (function chrome(){
Â  Â  Â  const name = localStorage.getItem('username')||'';
Â  Â  Â  const ub = document.getElementById('userBadge');
Â  Â  Â  if (name && ub){ ub.style.display='inline-flex'; ub.innerHTML = userIcon()+`<span>${esc(name)}</span>`; }
Â  Â  Â  document.getElementById('logoutBtn').addEventListener('click', ()=>{
Â  Â  Â  Â  const btn = document.getElementById('logoutBtn');
Â  Â  Â  Â  btn.disabled = true; btn.style.minWidth = btn.offsetWidth + 'px';
Â  Â  Â  Â  btn.innerHTML = '<span class="spinner"></span> Logging outâ€¦';
Â  Â  Â  Â  try{ localStorage.removeItem('token'); localStorage.removeItem('role'); localStorage.removeItem('username'); }catch{}
Â  Â  Â  Â  setTimeout(()=>location.replace('/login'), 600);
Â  Â  Â  });
Â  Â  Â  if (isAdmin()){
Â  Â  Â  Â  document.getElementById('adminBar').style.display = 'block';
Â  Â  Â  Â  const d = document.getElementById('d_date');
Â  Â  Â  Â  if (d && !d.value) d.valueAsDate = new Date();
Â  Â  Â  }
Â  Â  })();

Â  Â  /* ----- UPLOAD (Base64 â†’ GAS) ----- */
Â  Â  document.getElementById('btnPick')?.addEventListener('click', ()=>document.getElementById('pickFile').click());
Â  Â  document.getElementById('pickFile')?.addEventListener('change', (e)=>{
Â  Â  Â  const f = e.target.files && e.target.files[0];
Â  Â  Â  if(!f) return;
Â  Â  Â  const r = new FileReader();
Â  Â  Â  setUploadBusy(true);
Â  Â  Â  r.onload = async ()=>{
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const base64 = String(r.result).split(',')[1];
Â  Â  Â  Â  Â  const res = await fetch(`${API}?action=uploaddocb64&token=${encodeURIComponent(getTok())}`, {
Â  Â  Â  Â  Â  Â  method:'POST',
Â  Â  Â  Â  Â  Â  headers:{'content-type':'application/json'},
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ name:f.name, mime:f.type||'application/octet-stream', data: base64 })
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const j = await res.json();
Â  Â  Â  Â  Â  if(!j.ok) throw new Error(j.error||'Upload failed');
Â  Â  Â  Â  Â  // Prefill subject and store the returned link in URL (weâ€™ll save it as Media)
Â  Â  Â  Â  Â  const subj = document.getElementById('d_subject');
Â  Â  Â  Â  Â  const urlÂ  = document.getElementById('d_url');
Â  Â  Â  Â  Â  if (subj && !subj.value) subj.value = j.data.name || f.name;
Â  Â  Â  Â  Â  if (url) url.value = j.data.url;
Â  Â  Â  Â  }catch(err){ alert('Upload error: ' + err.message); }
Â  Â  Â  Â  finally{ setUploadBusy(false); e.target.value=''; }
Â  Â  Â  };
Â  Â  Â  r.readAsDataURL(f);
Â  Â  });

Â  Â  /* ----- SHEET READ ----- */
Â  Â  async function fetchDocs(){
Â  Â  Â  const status = document.getElementById('status');
Â  Â  Â  status.textContent = 'Loadingâ€¦';
Â  Â  Â  const url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/gviz/tq?sheet=${encodeURIComponent(SHEET_TAB)}&tqx=out:json`;
Â  Â  Â  const res = await fetch(url, {cache:'no-store'});
Â  Â  Â  if(!res.ok) throw new Error('HTTP '+res.status);
Â  Â  Â  const text = await res.text();
Â  Â  Â  const a = text.indexOf('{'), b = text.lastIndexOf('}');
Â  Â  Â  const json = JSON.parse(text.slice(a,b+1));
Â  Â  Â  const cols = json.table.cols.map(c => (c.label||c.id||'').trim());

Â  Â  Â  // Expect: A Serial Number | B Subject | C Date | D Media | E URL
Â  Â  Â  const idx = {
Â  Â  Â  Â  serial: cols.findIndex(x=>/^serial/i.test(x)),
Â  Â  Â  Â  subject: cols.findIndex(x=>/^subject$/i.test(x)),
Â  Â  Â  Â  date: cols.findIndex(x=>/^date$/i.test(x)),
Â  Â  Â  Â  media: cols.findIndex(x=>/^media$/i.test(x)),
Â  Â  Â  Â  url: cols.findIndex(x=>/^url|^link/i.test(x)),
Â  Â  Â  };

Â  Â  Â  const rows = (json.table.rows||[]).map(r => (r.c||[]).map(c => c ? c.v : ''));
Â  Â  Â  const data = rows.map(r => ({
Â  Â  Â  Â  serial: r[idx.serial] ?? '',
Â  Â  Â  Â  subject: r[idx.subject] ?? '',
Â  Â  Â  Â  date: r[idx.date] ?? '',
Â  Â  Â  Â  media: r[idx.media] ?? '',
Â  Â  Â  Â  url: r[idx.url] ?? ''
Â  Â  Â  })).filter(r => r.subject || r.media || r.url);

Â  Â  Â  status.textContent = `Loaded ${data.length} document(s)`;
Â  Â  Â  return data;
Â  Â  }

Â  Â  /* ----- MEDIA RENDERING (Drive aware) ----- */
Â  Â  const fileIcon = {
Â  Â  Â  gdoc:Â  'ğŸ“ Google Doc',
Â  Â  Â  gsheet:'ğŸ“Š Google Sheet',
Â  Â  Â  gslides:'ğŸ“ˆ Google Slide',
Â  Â  Â  pdf:Â  Â 'ğŸ“„ PDF',
Â  Â  Â  word:Â  'ğŸ“ Word',
Â  Â  Â  excel: 'ğŸ“Š Excel',
Â  Â  Â  ppt:Â  Â 'ğŸ“ˆ PPT',
Â  Â  Â  other: 'ğŸ“ File'
Â  Â  };

Â  Â  function classifyByUrl(u){
Â  Â  Â  if(!u) return null;
Â  Â  Â  const s = String(u);

Â  Â  Â  // Google-native docs
Â  Â  Â  if (/docs\.google\.com\/document\//i.test(s))Â  Â  Â return 'gdoc';
Â  Â  Â  if (/docs\.google\.com\/spreadsheets\//i.test(s)) return 'gsheet';
Â  Â  Â  if (/docs\.google\.com\/presentation\//i.test(s)) return 'gslides';

Â  Â  Â  // Plain extensions (non-Drive direct links)
Â  Â  Â  if (/\.(jpg|jpeg|png|gif|webp)(\?|#|$)/i.test(s)) return 'image';
Â  Â  Â  if (/\.(mp4|webm|mov)(\?|#|$)/i.test(s))Â  Â  Â  Â  Â  return 'video';
Â  Â  Â  if (/\.(pdf)(\?|#|$)/i.test(s))Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return 'pdf';
Â  Â  Â  if (/\.(docx?|odt)(\?|#|$)/i.test(s))Â  Â  Â  Â  Â  Â  Â return 'word';
Â  Â  Â  if (/\.(xlsx?|ods)(\?|#|$)/i.test(s))Â  Â  Â  Â  Â  Â  Â return 'excel';
Â  Â  Â  if (/\.(pptx?|odp)(\?|#|$)/i.test(s))Â  Â  Â  Â  Â  Â  Â return 'ppt';

Â  Â  Â  // Google Drive share link (no extension)
Â  Â  Â  if (/drive\.google\.com\/file\/d\/([^/]+)/i.test(s)) return 'drive';
Â  Â  Â  return 'other';
Â  Â  }

Â  Â  function mediaCellHtml(url){
Â  Â  Â  if(!url) return '';

Â  Â  Â  // For Drive links, try the thumbnail first
Â  Â  Â  const m = url.match(/drive\.google\.com\/file\/d\/([^/]+)/i);
Â  Â  Â  if (m) {
Â  Â  Â  Â  const idÂ  Â  = m[1];
Â  Â  Â  Â  const thumb = `https://drive.google.com/thumbnail?id=${id}`;

Â  Â  Â  Â  // If the thumb 404s (e.g., a non-previewable file), show a simple link instead
Â  Â  Â  Â  const fallback = `
Â  Â  Â  Â  Â  <span class="file-fallback" style="display:none">
Â  Â  Â  Â  Â  Â  <a href="${esc(url)}" target="_blank" rel="noopener">ğŸ“ File</a>
Â  Â  Â  Â  Â  </span>`;
Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  <span class="drive-media">
Â  Â  Â  Â  Â  Â  <img class="thumb" src="${esc(thumb)}" alt="preview"
Â  Â  Â  Â  Â  Â  Â  Â  Â onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
Â  Â  Â  Â  Â  Â  ${fallback}
Â  Â  Â  Â  Â  </span>`;
Â  Â  Â  }

Â  Â  Â  // Non-Drive: extension-based rendering
Â  Â  Â  const kind = classifyByUrl(url);
Â  Â  Â  if (kind === 'image')Â  return `<img src="${esc(url)}" class="thumb" alt="image">`;
Â  Â  Â  if (kind === 'video')Â  return `<video src="${esc(url)}" class="thumb" controls></video>`;
Â  Â  Â  if (kind === 'pdf')Â  Â  return `<a href="${esc(url)}" target="_blank" rel="noopener">${fileIcon.pdf}</a>`;
Â  Â  Â  if (kind === 'word')Â  Â return `<a href="${esc(url)}" target="_blank" rel="noopener">${fileIcon.word}</a>`;
Â  Â  Â  if (kind === 'excel')Â  return `<a href="${esc(url)}" target="_blank" rel="noopener">${fileIcon.excel}</a>`;
Â  Â  Â  if (kind === 'ppt')Â  Â  return `<a href="${esc(url)}" target="_blank" rel="noopener">${fileIcon.ppt}</a>`;
Â  Â  Â  if (kind === 'gdoc')Â  Â return `<a href="${esc(url)}" target="_blank" rel="noopener">${fileIcon.gdoc}</a>`;
Â  Â  Â  if (kind === 'gsheet') return `<a href="${esc(url)}" target="_blank" rel="noopener">${fileIcon.gsheet}</a>`;
Â  Â  Â  if (kind === 'gslides')return `<a href="${esc(url)}" target="_blank" rel="noopener">${fileIcon.gslides}</a>`;
Â  Â  Â  return `<a href="${esc(url)}" target="_blank" rel="noopener">${fileIcon.other}</a>`;
Â  Â  }

Â  Â  /* ----- RENDER ----- */
Â  Â  let all = [];
Â  Â  function render(){
Â  Â  Â  const q = (document.getElementById('q').value||'').toLowerCase().trim();
Â  Â  Â  const tbody = document.querySelector('#grid tbody');
Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  const filtered = all.filter(r => !q || String(r.subject||'').toLowerCase().includes(q));
Â  Â  Â  filtered.forEach(r=>{
Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  // Link column shows ONLY when there is no media (per your rule)
Â  Â  Â  Â  const linkCell = (!r.media && r.url) ? `<a href="${esc(r.url)}" target="_blank" rel="noopener">Open</a>` : '';
Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  <td>${esc(r.serial)}</td>
Â  Â  Â  Â  Â  <td>${esc(r.date)}</td>
Â  Â  Â  Â  Â  <td>${esc(r.subject)}</td>
Â  Â  Â  Â  Â  <td>${mediaCellHtml(r.media)}</td>
Â  Â  Â  Â  Â  <td>${linkCell}</td>`;
Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  });
Â  Â  }

Â  Â  document.getElementById('q').addEventListener('input', render);

Â  Â  // Add row to sheet (admin)
Â  Â  document.getElementById('d_add')?.addEventListener('click', async ()=>{
Â  Â  Â  if(!isAdmin()) return;
Â  Â  Â  const subject = document.getElementById('d_subject').value.trim();
Â  Â  Â  const dateÂ  Â  = document.getElementById('d_date').value;
Â  Â  Â  const mediaÂ  Â = document.getElementById('d_url').value.trim(); // uploaded file link or any URL
Â  Â  Â  const sÂ  Â  Â  Â = document.getElementById('d_status');
Â  Â  Â  if(!subject || !date || !media){
Â  Â  Â  Â  s.textContent = 'Fill subject, date and a media/link value.';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  s.textContent = 'Addingâ€¦';
Â  Â  Â  try{
Â  Â  Â  Â  const res = await fetch(`${API}?action=adddoc&token=${encodeURIComponent(getTok())}`, {
Â  Â  Â  Â  Â  method:'POST', headers:{'Content-Type':'application/json'},
Â  Â  Â  Â  Â  body: JSON.stringify({ subject, date, media })Â  Â // GAS expects: subject/date/media (URL optional)
Â  Â  Â  Â  });
Â  Â  Â  Â  const j = await res.json().catch(()=>({}));
Â  Â  Â  Â  if(!j.ok) throw new Error(j.error || 'Failed');
Â  Â  Â  Â  s.textContent = 'Added.';
Â  Â  Â  Â  document.getElementById('d_subject').value='';
Â  Â  Â  Â  document.getElementById('d_url').value='';
Â  Â  Â  Â  all = await fetchDocs(); render();
Â  Â  Â  }catch(e){ s.textContent = 'Failed to add.'; }
Â  Â  });

Â  Â  // Init
Â  Â  (async function init(){
Â  Â  Â  try{ all = await fetchDocs(); render(); }
Â  Â  Â  catch(e){ document.getElementById('status').textContent = 'Failed to load (publish sheet or check ID)'; }
Â  Â  })();
Â  </script>
</body>
</html>
