<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="alternate icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Document Repository | Global Hillview</title>

  <!-- Guard if not logged in -->
  <script>
    (function(){
      try{
        if(!localStorage.getItem('token')){
          document.documentElement.style.display='none';
          location.replace('/login');
        }
      }catch(_){
        document.documentElement.style.display='none';
        location.replace('/login');
      }
    })();
  </script>

  <style>
    :root{ --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb; --hover:#f1f5f9; --blue:#0d6efd; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans";background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;background:var(--bg);border-bottom:1px solid var(--border)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{height:28px;width:28px;border-radius:6px}
    .title{font-size:18px;font-weight:800;margin:0}
    .toolbar{display:flex;align-items:center;gap:8px}
    .userpill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card);font-weight:600}
    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{background:var(--hover)}
    .btn.primary{background:var(--blue);color:#fff;border-color:transparent}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid currentColor; border-right-color:transparent; display:inline-block; animation:spin .7s linear infinite }

    .wrap{padding:14px 20px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input{padding:10px 12px;border:1px solid var(--border);border-radius:10px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:10px;text-align:left;font-weight:700}
    tbody td{border-top:1px solid var(--border);padding:10px;vertical-align:top}
    .muted{color:var(--muted)}
    .thumb{max-width:64px;max-height:64px;object-fit:cover;border-radius:6px;border:1px solid var(--border)}
  </style>
</head>
<body>
  <input id="pickFile" type="file" style="display:none" />
  <header>
    <div class="brand">
      <img src="/android-chrome-512x512.png" alt="logo">
      <h1 class="title">Document Repository</h1>
    </div>
    <div class="toolbar">
      <span id="userBadge" class="userpill" style="display:none"></span>
      <button class="btn" onclick="location.href='/'">Back to Dashboard</button>
      <button class="btn danger" id="logoutBtn">Logout</button>
    </div>
  </header>

  <div class="wrap">
    <div id="adminBar" class="card" style="display:none; margin-bottom:12px">
      <div class="row" style="align-items:center">
        <button id="btnPick" class="btn primary">Upload to Drive</button>
        <span class="muted">Pick a file from your computer. It will upload to the shared Drive folder and the link will be recorded below.</span>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="d_subject" placeholder="Subject" style="flex:2 1 260px">
        <input id="d_date" type="date" style="flex:1 1 160px">
        <input id="d_url" placeholder="Document URL (share link)" style="flex:2 1 260px">
      </div>
      <div class="row" style="margin-top:8px">
        <button id="d_add" class="btn">Add entry</button>
        <span id="d_status" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <div class="row" style="margin-bottom:8px">
        <input id="q" type="search" placeholder="Search subject‚Ä¶" style="min-width:260px">
        <span id="status" class="muted" style="margin-left:auto"></span>
      </div>

      <div style="overflow:auto;border:1px solid var(--border);border-radius:12px">
        <table id="grid">
          <thead><tr>
            <th style="width:80px">Serial #</th>
            <th style="width:160px">Date</th>
            <th>Subject</th>
            <th>Media</th>
            <th>Link</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const API = '/api';
const SHEET_ID = '1mTEgG-bjumtytA3oHFyF0U1Mh5XjYoJx2BolcIuSuBk';
const SHEET_TAB = 'Documents';
const DRIVE_FOLDER_ID = '1lFHxYeF3z73Zn75sRU0aG12tT93JGDjN';

const esc = s => String(s||'');
const getTok = () => localStorage.getItem('token');
const isAdmin = () => (localStorage.getItem('role') === 'admin');

function setUploadBusy(on){
  const btn = document.getElementById('btnPick');
  if (on){ btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Uploading‚Ä¶'; }
  else { btn.disabled = false; btn.innerHTML = 'Upload to Drive'; }
}

// File ‚Üí base64 ‚Üí POST to GAS
document.getElementById('btnPick').addEventListener('click', ()=>document.getElementById('pickFile').click());
document.getElementById('pickFile').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  setUploadBusy(true);
  r.onload = async ()=>{
    try{
      const base64 = r.result.split(',')[1];
      const res = await fetch(`/api?action=uploaddocb64&token=${encodeURIComponent(getTok())}`, {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify({ name:f.name, mime:f.type||'application/octet-stream', data: base64 })
      });
      const j = await res.json();
      if(!j.ok) throw new Error(j.error||'Upload failed');
      document.getElementById('d_subject').value ||= f.name;
      // save file url in Media column when adding
      document.getElementById('d_url').value = j.data.url;
    }catch(err){ alert('Upload error: ' + err.message); }
    finally{ setUploadBusy(false); e.target.value=''; }
  };
  r.readAsDataURL(f);
});

async function fetchDocs(){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_TAB}&tqx=out:json`;
  const res = await fetch(url); const txt = await res.text();
  const a=txt.indexOf('{'), b=txt.lastIndexOf('}');
  const json = JSON.parse(txt.slice(a,b+1));
  const cols = json.table.cols.map(c=>(c.label||c.id||'').trim());
  const rows = (json.table.rows||[]).map(r=>(r.c||[]).map(c=>c?c.v:''));

  const idx={serial:cols.indexOf('Serial Number'), subject:cols.indexOf('Subject'),
             date:cols.indexOf('Date'), media:cols.indexOf('Media'), url:cols.indexOf('URL')};

  return rows.map(r=>({serial:r[idx.serial],subject:r[idx.subject],date:r[idx.date],media:r[idx.media],url:r[idx.url]}))
             .filter(r=>r.subject||r.media||r.url);
}

let all=[];

<script>
  /* ‚Ä¶keep your code above‚Ä¶ */

  // quick icon labels (you can swap for inline SVGs later)
  const fileIcon = {
    gdoc:  'üìù Google Doc',
    gsheet:'üìä Google Sheet',
    gslides:'üìà Google Slide',
    pdf:   'üìÑ PDF',
    word:  'üìù Word',
    excel: 'üìä Excel',
    ppt:   'üìà PPT',
    other: 'üìé File'
  };

  function classifyByUrl(u){
    if(!u) return null;
    const s = String(u);
    // Google-native (no file extension)
    if (/docs\.google\.com\/document\/d\//i.test(s))   return 'gdoc';
    if (/docs\.google\.com\/spreadsheets\/d\//i.test(s)) return 'gsheet';
    if (/docs\.google\.com\/presentation\/d\//i.test(s)) return 'gslides';

    // by extension for non-native
    if (/\.(pdf)(\?|#|$)/i.test(s))                  return 'pdf';
    if (/\.(docx?|odt)(\?|#|$)/i.test(s))            return 'word';
    if (/\.(xlsx?|ods)(\?|#|$)/i.test(s))            return 'excel';
    if (/\.(pptx?|odp)(\?|#|$)/i.test(s))            return 'ppt';
    if (/\.(jpg|jpeg|png|gif|webp)(\?|#|$)/i.test(s)) return 'image';
    if (/\.(mp4|webm|mov)(\?|#|$)/i.test(s))          return 'video';
    return 'other';
  }

  function mediaCellHtml(url){
    if(!url) return '';
    const kind = classifyByUrl(url);

    if (kind === 'image')  return `<img src="${esc(url)}" class="thumb" alt="image">`;
    if (kind === 'video')  return `<video src="${esc(url)}" class="thumb" controls></video>`;

    // icons for the rest (clickable)
    const label = fileIcon[kind] || fileIcon.other;
    return `<a href="${esc(url)}" target="_blank" rel="noopener">${label}</a>`;
  }
  
  
  
function render(){
  const q=document.getElementById('q').value.toLowerCase();
  const tbody=document.querySelector('#grid tbody'); tbody.innerHTML='';
  all.filter(r=>!q||String(r.subject||'').toLowerCase().includes(q)).forEach(r=>{
    const mediaCell = mediaCellHtml(r.media);        // <‚Äî changed
    const linkCell  = r.url ? `<a href="${esc(r.url)}" target="_blank">Open</a>` : '';
    tbody.innerHTML += `
      <tr>
        <td>${esc(r.serial)}</td>
        <td>${esc(r.date)}</td>
        <td>${esc(r.subject)}</td>
        <td>${mediaCell}</td>
        <td>${linkCell}</td>
      </tr>`;
  });
}

document.getElementById('d_add')?.addEventListener('click', async()=>{
  if(!isAdmin()) return;
  const subject=document.getElementById('d_subject').value.trim();
  const date=document.getElementById('d_date').value;
  const media=document.getElementById('d_url').value.trim(); // treat as media if from upload
  const s=document.getElementById('d_status');
  if(!subject||!date||( !media )){ s.textContent='Fill subject, date and media/url.'; return; }
  s.textContent='Adding‚Ä¶';
  try{
    const res=await fetch(`${API}?action=adddoc&token=${encodeURIComponent(getTok())}`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({subject,date,media})
    });
    const j=await res.json(); if(!j.ok) throw new Error(j.error||'Failed');
    s.textContent='Added.'; document.getElementById('d_subject').value='';document.getElementById('d_url').value='';
    all=await fetchDocs(); render();
  }catch(e){ s.textContent='Failed to add.'; }
});

(async function init(){ all=await fetchDocs(); render(); })();
document.getElementById('q').addEventListener('input', render);
</script>
</body>
</html>
