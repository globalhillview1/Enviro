<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Document Repository</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; --hover:#f1f5f9; --blue:#0d6efd; --danger:#ef4444; }

    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; color:var(--text) }

    /* ===== Top app header ===== */
    header{
      position:sticky; top:0; z-index:10;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 16px; background:var(--bg); border-bottom:1px solid var(--border)
    }
    .brand{ display:flex; align-items:center; gap:10px }
    .brand img{ height:28px; width:28px; border-radius:6px; object-fit:cover }
    .title{ margin:0; font-weight:800 }

    /* ===== Buttons / inputs ===== */
    .btn{ appearance:none; border:1px solid var(--border); background:var(--card); padding:8px 10px; border-radius:10px; cursor:pointer }
    .btn:hover{ background:var(--hover) }
    .btn.primary{ background:var(--blue); color:#fff; border-color:transparent }
    .btn.danger{ background:var(--danger); color:#fff; border-color:transparent }
    input,select,textarea{ padding:8px 10px; border:1px solid var(--border); border-radius:8px; font:inherit }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .wrap{ padding:14px 16px }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px }
    .muted{ color:var(--muted) }
    .hidden{ display:none }

    /* ===== Table + sticky header ===== */
    .tableWrap{
      overflow:auto;
      border:1px solid var(--border);
      border-radius:12px;
      max-height: calc(100vh - 210px);
      background:var(--card);
    }
    table{ width:100%; border-collapse:separate; border-spacing:0; background:var(--card) }
    thead th{
      position:sticky;
      top:0;
      z-index:1;
      background:var(--card);
      border-bottom:1px solid var(--border);
      padding:10px; text-align:left; font-weight:700; white-space:nowrap
    }
    tbody td{ border-top:1px solid var(--border); padding:10px; vertical-align:top }
    th.sort{ cursor:pointer; user-select:none }
    th.sort:after{ content:" ⇵"; color:#94a3b8; font-weight:400 }
    th.sort.asc:after{ content:" ↑" } th.sort.desc:after{ content:" ↓" }

    /* media/link previews */
    .thumb{ width:58px; height:44px; object-fit:cover; border-radius:5px; border:1px solid #e5e7eb; background:#f8fafc }
    .fileicon{ display:inline-flex; align-items:center; gap:6px; padding:3px 6px; border:1px solid #e5e7eb; border-radius:6px; color:#334155; background:#f8fafc; font-size:12px }
    .fileicon svg{ width:14px; height:14px }
    .media-stack{ display:flex; gap:6px; flex-wrap:wrap; align-items:center }
    .badge{ font-size:12px; padding:2px 6px; border-radius:999px; border:1px solid var(--border); background:#f8fafc; color:#334155 }

    .pager{ display:flex; gap:8px; align-items:center; margin-top:10px }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <img src="/android-chrome-512x512.png" onerror="this.src='logo.png'" alt="logo">
    <h1 class="title">Document Repository</h1>
  </div>
  <div class="row">
    <button class="btn" onclick="location.href='/'">Back to Dashboard</button>
    <button class="btn danger" onclick="logout()">Logout</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <!-- Controls -->
    <div class="row" style="margin-bottom:8px">
      <input id="q" placeholder="Quick search…" style="min-width:260px">
      <button id="addBtn" class="btn primary hidden">+ Add Document</button>
      <button id="catBtn" class="btn hidden">Manage Categories</button>
      <span id="meta" class="muted"></span>
      <span id="status" class="muted" style="margin-left:auto"></span>
    </div>

    <!-- Table -->
    <div class="tableWrap">
      <table id="grid">
        <thead>
          <tr>
            <th class="sort" data-k="serial">Serial #</th>
            <th class="sort" data-k="date">Date</th>
            <th class="sort" data-k="subject">Subject</th>
            <th class="sort" data-k="category">Category</th>
            <th class="sort" data-k="media">Media</th>
            <th class="sort" data-k="url">Link</th>
            <th id="colActions">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="pager">
      <button id="prevBtn" class="btn">Prev</button>
      <span id="pageInfo" class="muted">Page 1 / 1</span>
      <button id="nextBtn" class="btn">Next</button>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div id="docModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center">
  <div class="box" style="background:#fff;border-radius:12px;border:1px solid var(--border);padding:16px;width:min(820px,94vw)">
    <h3 id="modalTitle">Add Document</h3>
    <input type="hidden" id="m_serial">

    <div class="row">
      <label>Date <input type="date" id="m_date"></label>
      <label style="flex:1 1 auto">Subject <input id="m_subject" style="width:100%"></label>
    </div>

    <div class="row" style="margin-top:8px">
      <label style="flex:1 1 auto">Category
        <div class="row">
          <select id="m_category" style="width:100%"></select>
          <button id="m_newcat" class="btn">New…</button>
        </div>
      </label>
    </div>

    <div style="margin-top:8px">
      <div class="row" style="align-items:center">
        <strong>Attachments</strong>
        <button id="m_browse" class="btn">Browse…</button>
        <span id="m_up_status" class="muted"></span>
      </div>
      <div id="m_files" class="row" style="margin-top:6px"></div>
      <small class="muted">You can select multiple files; they’ll be uploaded and saved in the Media column (one URL per line).</small>
    </div>

    <div style="margin-top:10px">
      <label style="display:block">Additional Link(s) — one per line
        <textarea id="m_url" rows="2" style="width:100%" placeholder="https://… (optional, one per line)"></textarea>
      </label>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button id="m_save" class="btn primary">Save</button>
      <span id="m_status" class="muted" style="margin-left:auto"></span>
    </div>

    <input id="m_file" type="file" style="display:none" multiple>
  </div>
</div>

<!-- Manage Categories Modal -->
<div id="catModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:50; align-items:center; justify-content:center">
  <div class="box" style="background:#fff;border-radius:12px;border:1px solid var(--border);padding:16px;width:min(820px,94vw)">
    <h3>Manage Categories</h3>
    <div id="catList" class="row" style="flex-wrap:wrap"></div>
    <div class="row" style="margin-top:10px">
      <input id="catNew" placeholder="New category">
      <button class="btn" onclick="addCategory()">Add</button>
      <span class="muted" style="margin-left:auto">Stored per-sheet (in cells) – this UI helps you reuse values.</span>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" onclick="closeCat()">Close</button>
    </div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const API = '/api';
const IST = 'Asia/Kolkata';
const PAGE = 12;

/* ========= Helpers ========= */
function logout(){ try{localStorage.clear()}catch{} location.replace('/login'); }
function token(){ try{return localStorage.getItem('token')}catch{ return null; } }
const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

function fmtDateIST(d){
  if(!d) return '';
  const dt = new Date(d);
  if(isNaN(dt)) return esc(d);
  const p = new Intl.DateTimeFormat('en-GB',{timeZone:IST,day:'2-digit',month:'2-digit',year:'numeric'}).formatToParts(dt);
  const g=k=>p.find(x=>x.type===k)?.value||''; return `${g('day')}-${g('month')}-${g('year')}`;
}
function toDateInputValueIST(d){
  const dt = d? new Date(d) : new Date();
  return new Intl.DateTimeFormat('en-CA',{timeZone:IST,year:'numeric',month:'2-digit',day:'2-digit'}).format(dt);
}
function gdriveId(url){
  if(!url) return null;
  const m=/\/d\/([a-zA-Z0-9_-]{10,})\//.exec(url)||/id=([a-zA-Z0-9_-]{10,})/.exec(url);
  return m?m[1]:null;
}
function driveThumb(url){
  const id=gdriveId(url);
  return id?`https://drive.google.com/thumbnail?authuser=0&sz=w200&id=${id}`:null;
}
function icon(kind,label){
  const svg={
    pdf:'<svg viewBox="0 0 24 24" fill="none"><path d="M6 2h8l4 4v16H6z" stroke="currentColor"/><text x="6" y="14" font-size="8" fill="currentColor">PDF</text></svg>',
    doc:'<svg viewBox="0 0 24 24" fill="none"><path d="M6 2h8l4 4v16H6z" stroke="currentColor"/><text x="6" y="14" font-size="8" fill="currentColor">DOC</text></svg>',
    xls:'<svg viewBox="0 0 24 24" fill="none"><path d="M6 2h8l4 4v16H6z" stroke="currentColor"/><text x="6" y="14" font-size="8" fill="currentColor">XLS</text></svg>',
    ppt:'<svg viewBox="0 0 24 24" fill="none"><path d="M6 2h8l4 4v16H6z" stroke="currentColor"/><text x="6" y="14" font-size="8" fill="currentColor">PPT</text></svg>',
    csv:'<svg viewBox="0 0 24 24" fill="none"><path d="M6 2h8l4 4v16H6z" stroke="currentColor"/><text x="6" y="14" font-size="8" fill="currentColor">CSV</text></svg>',
    zip:'<svg viewBox="0 0 24 24" fill="none"><rect x="5" y="2" width="14" height="20" rx="2" stroke="currentColor"/><path d="M12 4v14" stroke="currentColor" /><path d="M10 6h4M10 8h4M10 10h4" stroke="currentColor"/></svg>'
  }[kind]||'';
  return `<span class="fileicon">${svg}<span>${esc(label||kind)}</span></span>`;
}

/* Multiple-URL aware cells */
function splitLines(s){ return (String(s||'').trim()==='')? [] : String(s).split(/\r?\n/).map(x=>x.trim()).filter(Boolean); }

function mediaCellMulti(s){
  const urls = splitLines(s);
  if(urls.length===0) return '';
  const parts = [];
  for(let i=0;i<Math.min(3, urls.length);i++){
    const url = urls[i], l=url.toLowerCase(), th=driveThumb(url);
    if(/\.(png|jpg|jpeg|gif|webp)$/i.test(l) || th){
      const src = /\.(png|jpg|jpeg|gif|webp)$/i.test(l)?url:th;
      parts.push(`<a href="${esc(url)}" target="_blank"><img class="thumb" src="${esc(src)}" alt=""></a>`);
    }else if(/\.pdf($|\?)/i.test(l))  parts.push(`<a href="${esc(url)}" target="_blank">${icon('pdf','PDF')}</a>`);
    else if(/\.(doc|docx)($|\?)/i.test(l)) parts.push(`<a href="${esc(url)}" target="_blank">${icon('doc','DOC')}</a>`);
    else if(/\.(xls|xlsx)($|\?)/i.test(l)) parts.push(`<a href="${esc(url)}" target="_blank">${icon('xls','XLS')}</a>`);
    else if(/\.(ppt|pptx)($|\?)/i.test(l)) parts.push(`<a href="${esc(url)}" target="_blank">${icon('ppt','PPT')}</a>`);
    else if(/\.csv($|\?)/i.test(l))  parts.push(`<a href="${esc(url)}" target="_blank">${icon('csv','CSV')}</a>`);
    else if(/\.zip($|\?)/i.test(l))  parts.push(`<a href="${esc(url)}" target="_blank">${icon('zip','ZIP')}</a>`);
    else parts.push(`<a href="${esc(url)}" target="_blank">open</a>`);
  }
  const more = urls.length>3 ? `<span class="badge">+${urls.length-3}</span>` : '';
  return `<div class="media-stack">${parts.join('')}${more}</div>`;
}
function linkCellMulti(s){
  const urls = splitLines(s);
  if(urls.length===0) return '';
  const show = urls.slice(0,3).map(u=>`<a href="${esc(u)}" target="_blank">open</a>`).join(' · ');
  const more = urls.length>3 ? `<span class="badge">+${urls.length-3}</span>` : '';
  return `<div class="media-stack">${show}${more}</div>`;
}

/* ========= State ========= */
let isAdmin=false, all=[], rows=[], sortKey='date', sortDir='desc', page=1;
let categories=[];
let modalFiles = []; // array of attachment URLs

/* ========= Filtering ========= */
function apply(){
  const q = (document.getElementById('q').value||'').toLowerCase();
  rows = all.filter(r=>{
    const hay=(r.serial+' '+fmtDateIST(r.date)+' '+r.subject+' '+r.category+' '+r.media+' '+r.url).toLowerCase();
    return q ? hay.includes(q) : true;
  }).sort((a,b)=>{
    let A,B;
    if(sortKey==='date'){ A=new Date(a.date||0); B=new Date(b.date||0); }
    else { A=(a[sortKey]??'').toString().toLowerCase(); B=(b[sortKey]??'').toString().toLowerCase(); }
    const s=(A<B?-1:A>B?1:0); return sortDir==='asc'?s:-s;
  });
  page=1; render();
}

/* ========= Render ========= */
function render(){
  const tbody=document.querySelector('#grid tbody'); tbody.innerHTML='';
  const total=rows.length, pages=Math.max(1,Math.ceil(total/PAGE));
  page=Math.min(Math.max(1,page),pages);
  const part=rows.slice((page-1)*PAGE,(page-1)*PAGE+PAGE);
  part.forEach(r=>{
    const actions = isAdmin
      ? `<td><button class="btn" onclick="openModal(true, ${r.serial})">Edit</button>
          <button class="btn danger" onclick="delDoc(${r.serial})">Delete</button></td>`
      : ''; // omit the entire cell when not admin

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(r.serial)}</td>
      <td>${fmtDateIST(r.date)}</td>
      <td>${esc(r.subject)}</td>
      <td>${esc(r.category||'')}</td>
      <td>${mediaCellMulti(r.media)}</td>
      <td>${linkCellMulti(r.url)}</td>
      ${actions}`;
    tbody.appendChild(tr);
  });
  document.getElementById('pageInfo').textContent=`Page ${page} / ${pages}`;
  document.getElementById('status').textContent=`${total} document(s), showing ${part.length}`;
}

/* ========= API ========= */
async function whoami(){
  const r=await fetch(`${API}?action=whoami&token=${encodeURIComponent(token())}`,{cache:'no-store'});
  const j=await r.json(); if(!j.ok) throw new Error('unauthorized');
  return j.data.user;
}
async function fetchDocs(){
  document.getElementById('status').textContent='Loading…';
  const r=await fetch(`${API}?action=documents&token=${encodeURIComponent(token())}`,{cache:'no-store'});
  const j=await r.json(); if(!j.ok) throw new Error(j.error||'Failed');
  all=(j.data||[]).map(x=>x);
  categories = [...new Set(all.map(x=>(x.category||'')).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  fillCategorySelect();
  apply();
}

/* ========= Modal / CRUD ========= */
function fillCategorySelect(){
  const sel=document.getElementById('m_category');
  sel.innerHTML = categories.map(c=>`<option>${esc(c)}</option>`).join('') + `<option value="">(none)</option>`;
  document.getElementById('catList').innerHTML = categories.map(c=>`<span class="fileicon" style="margin:4px 6px 0 0">${esc(c)}</span>`).join('')||'<span class="muted">No categories yet</span>';
}
function renderModalFiles(){
  const wrap = document.getElementById('m_files');
  wrap.innerHTML = modalFiles.map((u,idx)=>(
    `<span class="fileicon" title="${esc(u)}">file<span class="x" style="margin-left:6px;cursor:pointer;color:#ef4444" onclick="removeModalFile(${idx})">×</span></span>`
  )).join('') || '<span class="muted">No attachments</span>';
}
function removeModalFile(i){ modalFiles.splice(i,1); renderModalFiles(); }

function openModal(edit=false, serial=null){
  document.getElementById('m_status').textContent='';
  document.getElementById('m_up_status').textContent='';
  document.getElementById('modalTitle').textContent = edit?'Edit Document':'Add Document';
  document.getElementById('docModal').style.display='flex';

  if(edit){
    const rec=all.find(x=>x.serial==serial);
    document.getElementById('m_serial').value = rec.serial;
    document.getElementById('m_date').value = toDateInputValueIST(rec.date);
    document.getElementById('m_subject').value = rec.subject||'';
    document.getElementById('m_url').value = splitLines(rec.url).join('\n');
    fillCategorySelect(); document.getElementById('m_category').value = rec.category||'';
    modalFiles = splitLines(rec.media);
  }else{
    document.getElementById('m_serial').value = '';
    document.getElementById('m_date').value = toDateInputValueIST();
    document.getElementById('m_subject').value = '';
    document.getElementById('m_url').value = '';
    fillCategorySelect(); document.getElementById('m_category').value = '';
    modalFiles = [];
  }
  renderModalFiles();
}
function closeModal(){ document.getElementById('docModal').style.display='none'; }

async function saveModal(){
  const s=document.getElementById('m_status');
  const payload = {
    serial: document.getElementById('m_serial').value || undefined,
    date: document.getElementById('m_date').value,
    subject: document.getElementById('m_subject').value.trim(),
    media: modalFiles.join('\n'),
    url: (document.getElementById('m_url').value||'').trim(),
    category: document.getElementById('m_category').value.trim()
  };
  if(!payload.subject){ s.textContent='Subject required'; return; }
  if(!payload.media && !payload.url){ s.textContent='Provide at least one attachment or a link'; return; }
  s.textContent='Saving…';
  try{
    const action = payload.serial? 'updatedoc':'adddoc';
    const r=await fetch(`${API}?action=${action}&token=${encodeURIComponent(token())}`,{
      method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
    });
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'Failed');
    s.textContent='Saved.'; closeModal(); await fetchDocs();
  }catch(e){ s.textContent='Save failed: '+e.message; }
}
async function delDoc(serial){
  if(!confirm('Delete document #'+serial+'?')) return;
  try{
    const r=await fetch(`${API}?action=deletedoc&token=${encodeURIComponent(token())}`,{
      method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({serial})
    });
    const j=await r.json(); if(!j.ok) throw new Error(j.error||'Failed');
    await fetchDocs();
  }catch(e){ alert('Delete failed: '+e.message); }
}
async function uploadMany(files){
  const stat = document.getElementById('m_up_status');
  if(!files || files.length===0) return;
  stat.textContent = `Uploading ${files.length} file(s)…`;
  let ok=0, fail=0;
  for(const file of files){
    try{
      const b64 = await file.arrayBuffer().then(b=>btoa(String.fromCharCode(...new Uint8Array(b))));
      const r = await fetch(`${API}?action=uploaddocb64&token=${encodeURIComponent(token())}`,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name:file.name, mime:file.type||'application/octet-stream', data:b64 })
      });
      const j = await r.json(); if(!j.ok) throw new Error(j.error||'upload failed');
      modalFiles.push(j.data.url); ok++;
    }catch(_){ fail++; }
  }
  renderModalFiles();
  stat.textContent = `Uploaded ${ok} file(s)` + (fail?`, ${fail} failed`:'') + '.';
}

/* ========= Categories ========= */
function openCat(){ document.getElementById('catModal').style.display='flex'; }
function closeCat(){ document.getElementById('catModal').style.display='none'; }
function addCategory(){
  const v=document.getElementById('catNew').value.trim(); if(!v) return;
  if(!categories.includes(v)) categories.push(v);
  categories = [...new Set(categories)].sort((a,b)=>a.localeCompare(b));
  document.getElementById('catNew').value=''; fillCategorySelect();
}

/* ========= Wire-up ========= */
function attachSort(){
  document.querySelectorAll('thead th.sort').forEach(th=>{
    th.addEventListener('click',()=>{
      const k=th.dataset.k;
      if(sortKey===k) sortDir=(sortDir==='asc'?'desc':'asc');
      else { sortKey=k; sortDir='asc'; }
      document.querySelectorAll('thead th.sort').forEach(x=>x.classList.remove('asc','desc'));
      th.classList.add(sortDir); apply();
    });
  });
}
function attachInputs(){
  document.getElementById('q').addEventListener('input', apply);
  document.getElementById('prevBtn').onclick=()=>{ page=Math.max(1,page-1); render(); };
  document.getElementById('nextBtn').onclick=()=>{ page=page+1; render(); };

  document.getElementById('addBtn').onclick=()=>openModal(false);
  document.getElementById('m_browse').onclick=()=>document.getElementById('m_file').click();
  document.getElementById('m_file').addEventListener('change',(ev)=>uploadMany(ev.target.files));
  document.getElementById('m_newcat').onclick=openCat;
  document.getElementById('catBtn').onclick=openCat;
  document.getElementById('m_save').onclick=saveModal;
}

(async function init(){
  try{
    const me=await whoami();
    isAdmin = (me.role==='admin');

    // Toggle admin-only UI
    if(isAdmin){
      document.getElementById('addBtn').classList.remove('hidden');
      document.getElementById('catBtn').classList.remove('hidden');
    }else{
      // Hide Actions header for non-admins
      const th = document.getElementById('colActions');
      if (th) th.classList.add('hidden');
    }
  }catch{ return logout(); }

  document.getElementById('meta').textContent='Timezone: IST • Dates: DD-MM-YYYY';
  attachInputs(); attachSort();
  await fetchDocs();
})();
</script>
</body>
</html>
